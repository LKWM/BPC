<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chapitre 8 - Récapitulatif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --font-sm: clamp(0.75rem, 2vmin, 0.875rem);
            --font-base: clamp(0.875rem, 2.5vmin, 1rem);
            --font-lg: clamp(1rem, 3vmin, 1.25rem);
            --font-xl: clamp(1.125rem, 4vmin, 1.5rem);
            --font-title: clamp(1.5rem, 5vmin, 2rem);
            --padding-sm: clamp(0.5rem, 2vmin, 0.75rem);
            --padding-md: clamp(0.75rem, 3vmin, 1.5rem);
            --padding-lg: clamp(1rem, 4vmin, 2.5rem);
        }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 1rem; background-color: #f3f4f6;
        }

        .course-wrapper {
            width: 100%;
            max-width: 600px;
        }
        .course-container {
            width: 100%;
            position: relative;
            aspect-ratio: 1 / 1;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: white;
        }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;
            background-color: white; padding: var(--padding-lg);
            border-radius: 0.75rem;
            box-sizing: border-box;
        }
        #page-0 {
            justify-content: center;
        }
        #page-0 .page-content {
            flex-grow: 0;
        }
        .page.active { opacity: 1; visibility: visible; }
        .page-content {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        @media (max-width: 600px) {
            body { padding: 0; height: 100vh; max-height: -webkit-fill-available; }
            .course-wrapper { height: 100%; max-width: 100%; }
            .course-container { aspect-ratio: auto; height: 100%; border-radius: 0; }
            .page { padding: 1.5rem 1rem; border-radius: 0; }
        }

        .title-text { 
            font-size: var(--font-title); 
            font-weight: 700;
            color: #1f2937;
            text-align: center;
        }
        .lesson-text { font-size: var(--font-lg); }
        .nav-button { padding: var(--padding-sm) var(--padding-md); border-radius: 0.5rem; font-weight: 600; font-size: var(--font-base); transition: background-color 0.2s; cursor: pointer; }
        .nav-button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        .page-header {
            text-align: center; color: #4b5563; font-size: var(--font-lg);
            font-weight: 600; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem; flex-shrink: 0;
        }
        .audio-button { background: none; border: none; cursor: pointer; }
        .audio-icon { width: 3rem; height: 3rem; color: #6b7280; transition: color 0.2s; }
        .audio-button:hover .audio-icon { color: #1d4ed8; }

        .quiz-question { font-size: var(--font-lg); font-weight: 600; margin-bottom: 1rem; }
        .quiz-prompt { font-weight: 700; font-size: var(--font-title); color: #374151; margin-bottom: 1rem; font-family: 'Noto Sans KR', sans-serif; min-height: 50px;}
        .quiz-option {
            display: inline-flex; align-items: center; justify-content: center;
            padding: var(--padding-sm) var(--padding-md);
            border: 2px solid #d1d5db; border-radius: 0.5rem; margin: 0.25rem;
            cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
            font-family: 'Noto Sans KR', sans-serif; text-align: center;
        }
        .quiz-option span { font-size: var(--font-xl); }
        .quiz-option:hover { background-color: #f3f4f6; }
        .quiz-option.selected { background-color: #e0e7ff; border-color: #a5b4fc; }
        .quiz-option.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .quiz-option.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        .quiz-option input { display: none; }
        
        .feedback-area {
            text-align: right;
            min-height: 50px; 
            display: flex;
            align-items: center; 
            justify-content: flex-end;
            gap: 0.5rem;
            flex-grow: 1;
            font-size: var(--font-base);
            font-weight: 600;
        }
        
        .input-zone-container { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; min-height: clamp(60px, 20vmin, 80px); gap: 0.5rem;}
        .syllable-input {
            border: 2px solid #cbd5e1; background-color: #f9fafb;
            width: clamp(60px, 20vmin, 80px); height: clamp(60px, 20vmin, 80px);
            font-size: clamp(2rem, 10vmin, 3rem);
            font-family: 'Noto Sans KR', sans-serif; font-weight: 700;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: border-color 0.2s;
        }
        .jamo-bank { display: flex; flex-direction: column; gap: 0.25rem; justify-content: center; width: 100%; max-width: 500px; padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-top: 1rem; align-items: center; }
        .jamo-row { display: flex; flex-wrap: nowrap; gap: 0.25rem; justify-content: center; width: 100%; }
        .jamo-key {
            height: clamp(35px, 8vw, 40px);
            font-size: clamp(0.8rem, 3.5vw, 1.1rem);
            font-family: 'Noto Sans KR', sans-serif; border: 1px solid #d1d5db; border-radius: 0.25rem;
            background-color: #f9fafb; cursor: pointer; display:flex; align-items:center; justify-content:center;
            flex: 1; min-width: 0;
        }
        .jamo-key:hover { background-color: #f3f4f6; }
        .jamo-key:active { background-color: #e5e7eb; transform: translateY(1px); }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="course-wrapper">
        <div class="course-container">
            
            <div id="page-0" class="page active">
                <div class="page-content">
                    <h1 class="title-text font-bold text-gray-800 mb-6">Chapitre 8 - Récapitulatif</h1>
                    <p class="lesson-text text-gray-600">Vérifiez ce que vous avez appris au Chapitre 8.<br>C'est un test composé de 20 questions.</p>
                    <button onclick="showPage('quiz-page-1')" class="nav-button bg-blue-600 text-white hover:bg-blue-700 mt-10">Commencer le test</button>
                </div>
                <div></div>
            </div>

            <!-- QUIZ AND RESULT PAGES WILL BE GENERATED HERE -->

        </div>
    </div>
    
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="audio-icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
        </symbol>
    </svg>

    <script>
        let currentPageId = 'page-0';
        const totalQuestions = 20;
        let questionResults = new Array(totalQuestions).fill(false);
        let dictationState = {};
        let dictationAttempts = {}; 
        let initialNavStates = {};

        // Valid Hangul Jamos to allow input
        const validJamos = [
            'ㅂ', 'ㅈ', 'ㄷ', 'ㄱ', 'ㅅ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅐ', 'ㅔ',
            'ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ',
            'ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ',
            'ㅃ', 'ㅉ', 'ㄸ', 'ㄲ', 'ㅆ', 'ㅒ', 'ㅖ'
        ];

        const sounds = {
            'gam': { file: 'https://static.wixstatic.com/mp3/699687_023f3517caaf417985825a6f1ffc2928.mp3' }, 'tal': { file: 'https://static.wixstatic.com/mp3/699687_15d3e451e8ec4333a648d7320fcc05ab.mp3' }, 'mun': { file: 'https://static.wixstatic.com/mp3/699687_ba3cbab7c5564a5790edb89f3c9ad2d5.mp3' }, 'chang': { file: 'https://static.wixstatic.com/mp3/699687_7ba0d1da2caf4bbbac35378f049ff0e6.mp3' }, 'bom': { file: 'https://static.wixstatic.com/mp3/699687_0f8b1278611346d0a048ef5ea8d5e05e.mp3' }, 'yeonghwa': { file: 'https://static.wixstatic.com/mp3/699687_690073b12fce4ec69779a69eb4543160.mp3' }, 'jongi': { file: 'https://static.wixstatic.com/mp3/699687_221fcc2e070c48b58bc39daaaded8356.mp3' }, 'namu': { file: 'https://static.wixstatic.com/mp3/699687_8b95668f1d944283b80dea27b3d48f8d.mp3' }, 'kkaji': { file: 'https://static.wixstatic.com/mp3/699687_3a900e5abb6940d48fad2568d64edadf.mp3' }, 'swida': { file: 'https://static.wixstatic.com/mp3/699687_027ca43bbb55488ca464dae0b0d6907a.mp3' }, 'ma': { file: 'https://static.wixstatic.com/mp3/699687_a97f6a1309a9494b8be961e0f5666c56.mp3' }, 'jong': { file: 'https://static.wixstatic.com/mp3/699687_1f37c39b0a0d4dffb18877e5a34f65c4.mp3' }, 'gong': { file: 'https://static.wixstatic.com/mp3/699687_8392306375964831bd7e254e283d7ab8.mp3' }, 'saem': { file: 'https://static.wixstatic.com/mp3/699687_1f34a2922b1c423c846381403fdc6bd2.mp3' }, 'tol': { file: 'https://static.wixstatic.com/mp3/699687_503118e7e8e4469a8eb3994dc5d93b17.mp3' }, 'mal': { file: 'https://static.wixstatic.com/mp3/699687_62ae5f30cbf14749806d28bd351ba42f.mp3' }, 'gang': { file: 'https://static.wixstatic.com/mp3/699687_44c30ee2cd9e42ff8eb001f66a0b44f3.mp3' }, 'bang': { file: 'https://static.wixstatic.com/mp3/699687_c065955a571544588c47617c39f40b55.mp3' }, 'sigye': { file: 'https://static.wixstatic.com/mp3/699687_c3d5010c86fa4e00b3f58c75ac6e9c2a.mp3' }, 'dosi': { file: 'https://static.wixstatic.com/mp3/699687_1d0912a8fc5646e1ac36d590310dc1a8.mp3' },
        };
        
        const quizData = [
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'gam', options: ['강', '간', '감', '갈', '가'], answer: '감' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'tal', options: ['달', '탈', '단', '탄', '탐', '단'], answer: '탈' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'mun', options: ['문', '분', '묵', '북', '뭄', '붐'], answer: '문' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'chang', options: ['장', '창', '짱', '잔', '찬', '짠'], answer: '창' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'bom', options: ['본', '볼', '봉', '봄'], answer: '봄' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'yeonghwa', prompt: '_화', options: ['용', '영', '융', '염', '연'], answer: '영' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'jongi', prompt: '_이', options: ['종', '총', '정', '청', '존', '촌'], answer: '종' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'namu', prompt: '나_', options: ['무', '우', '모', '오', '부', '보'], answer: '무' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'kkaji', prompt: '_지', options: ['가', '카', '까', '각', '칵', '자', '차'], answer: '까' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'swida', prompt: '_다', options: ['서', '시', '수', '쉬', '쇠', '쉐', '숴'], answer: '쉬' },
            { type: 'dictation', audio: 'ma', answer: '마' }, { type: 'dictation', audio: 'jong', answer: '종' },
            { type: 'dictation', audio: 'gong', answer: '공' }, { type: 'dictation', audio: 'saem', answer: '샘' },
            { type: 'dictation', audio: 'tol', answer: '톨' }, { type: 'dictation', audio: 'mal', answer: '말' },
            { type: 'dictation', audio: 'gang', answer: '강' }, { type: 'dictation', audio: 'bang', answer: '방' },
            { type: 'dictation', audio: 'sigye', answer: '시계' }, { type: 'dictation', audio: 'dosi', answer: '도시' },
        ];

        function createQuizPages() {
            const container = document.querySelector('.course-container');
            let pagesHtml = '';

            quizData.forEach((data, index) => {
                const questionNumber = index + 1;
                let contentHtml = '';

                if (data.type.startsWith('mcq')) {
                    contentHtml = `
                        <p class="quiz-question">${data.question}</p>
                        ${data.prompt ? `<p class="quiz-prompt">${data.prompt}</p>` : ''}
                        <button class="audio-button" onclick="playSound('${data.audio}')"><svg class="audio-icon mx-auto"><use href="#audio-icon-svg"/></svg></button>
                        <div class="flex flex-wrap justify-center gap-2">
                        ${data.options.map(opt => `<label class="quiz-option"><span>${opt}</span><input type="radio" name="q${questionNumber}" value="${opt}"></label>`).join('')}
                        </div>
                    `;
                } else { // dictation
                    contentHtml = `
                        <p class="quiz-question">Écrivez en coréen.</p>
                        <button class="audio-button" onclick="playSound('${data.audio}')"><svg class="audio-icon mx-auto"><use href="#audio-icon-svg"/></svg></button>
                        <div class="input-zone-container" id="input-zone-${questionNumber}"></div>
                        <div class="jamo-bank" id="jamo-bank-${questionNumber}"></div>
                    `;
                }

                const prevButtonHtml = questionNumber > 1 ? `<button onclick="showPage('quiz-page-${questionNumber - 1}')" class="nav-button text-gray-600 hover:bg-gray-200" id="prev-btn-${questionNumber}">&larr; Précédent</button>` : `<div></div>`;

                const navButtonHtml = `
                    <div id="quiz-${questionNumber}-nav" class="flex justify-between items-center w-full">
                        ${prevButtonHtml}
                        <div class="flex items-center gap-2 flex-grow justify-end">
                            <div id="q${questionNumber}-feedback" class="feedback-area"></div>
                            <button id="submit-btn-${questionNumber}" data-state="check" onclick="submitAnswerAndProceed(${questionNumber})" class="nav-button text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Vérifier</button>
                        </div>
                    </div>`;

                pagesHtml += `
                    <div id="quiz-page-${questionNumber}" class="page">
                        <div class="page-header w-full">${questionNumber} / ${totalQuestions}</div>
                        <div class="page-content flex flex-col justify-center items-center">
                            ${contentHtml}
                        </div>
                        ${navButtonHtml}
                    </div>
                `;
                
                dictationAttempts[questionNumber] = 0;
            });
            
            pagesHtml += `
                <div id="results-page" class="page items-center justify-center text-center">
                    <div class="page-content flex flex-col items-center justify-center">
                        <h2 class="title-text font-bold text-gray-800 mb-4">Résultats du test</h2>
                        <p id="score-display" class="text-5xl font-bold text-blue-600 mb-6"></p>
                        <p id="score-message" class="lesson-text text-gray-600"></p>
                    </div>
                </div>
            `;

            container.innerHTML += pagesHtml;
        }

        function playSound(soundKey) {
            if (!sounds[soundKey]) return;
            Tone.start().then(() => {
                const player = new Tone.Player(sounds[soundKey].file).toDestination();
                player.autostart = true;
                player.onstop = () => player.dispose();
            });
        }

        function showPage(pageId) {
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) currentPage.classList.remove('active');
            
            const nextPage = document.getElementById(pageId);
            if (nextPage) {
                nextPage.classList.add('active');
                currentPageId = pageId;
                resetPageState(nextPage);
            }
        }
        
        function resetPageState(pageElement) {
            const pageId = pageElement.id;
            const quizNumMatch = pageId.match(/quiz-page-(\d+)/);
            if (!quizNumMatch) return;
            
            const questionNumber = parseInt(quizNumMatch[1], 10);
            const data = quizData[questionNumber - 1];
            if (!data) return;

            const quizNav = pageElement.querySelector(`#quiz-${questionNumber}-nav`);
            if (quizNav && initialNavStates[quizNav.id]) {
                 quizNav.innerHTML = initialNavStates[quizNav.id];
                 const newCheckButton = quizNav.querySelector('button[onclick^="submit"]');
                 if (newCheckButton) {
                    newCheckButton.onclick = () => submitAnswerAndProceed(questionNumber);
                 }
                 const newPrevButton = quizNav.querySelector(`#prev-btn-${questionNumber}`);
                 if(newPrevButton) {
                    newPrevButton.onclick = () => showPage(`quiz-page-${questionNumber - 1}`);
                 }
            }
            
            dictationAttempts[questionNumber] = 0;

            if (data.type.startsWith('mcq')) {
                const options = pageElement.querySelectorAll(`input[name="q${questionNumber}"]`);
                options.forEach(opt => {
                    opt.disabled = false;
                    opt.checked = false;
                    opt.parentElement.classList.remove('selected', 'correct', 'wrong');
                    opt.parentElement.style.cursor = 'pointer';
                });
            } 
            else if (data.type === 'dictation') {
                setupDictationQuiz(questionNumber);
                const jamoKeys = pageElement.querySelectorAll('.jamo-key');
                jamoKeys.forEach(k => k.disabled = false);
            }
        }

        function submitAnswerAndProceed(questionNumber) {
            const submitBtn = document.getElementById(`submit-btn-${questionNumber}`);
            // Check button state. If it is 'next', proceed.
            if (submitBtn && submitBtn.dataset.state === 'next') {
                goToNext(questionNumber);
                return;
            }

            const data = quizData[questionNumber - 1];
            let isAnswered = false;
            let userAnswer = null;
            let isCorrect = false;

            if (data.type.startsWith('mcq')) {
                const selectedOption = document.querySelector(`input[name="q${questionNumber}"]:checked`);
                if (selectedOption) {
                    userAnswer = selectedOption.value;
                    isAnswered = true;
                }
            } else { // dictation
                const state = dictationState[questionNumber];
                if (state) {
                    userAnswer = state.inputs.map(syllableArray => combineHangeul(syllableArray)).join('');
                    if (userAnswer.length > 0) isAnswered = true;
                }
            }
            
            const feedbackEl = document.getElementById(`q${questionNumber}-feedback`);
            if (!isAnswered) {
                 if(feedbackEl) feedbackEl.innerHTML = `<span class="text-yellow-600">Veuillez répondre.</span>`;
                 setTimeout(() => { if(feedbackEl && feedbackEl.textContent.includes('Veuillez')) feedbackEl.innerHTML = ''; }, 2000);
                 return;
            }

            isCorrect = (userAnswer === data.answer);
            
            // --- MCQ Logic ---
            if (data.type.startsWith('mcq')) {
                if (isCorrect) {
                    const selectedLabel = document.querySelector(`input[name="q${questionNumber}"]:checked`).parentElement;
                    selectedLabel.classList.add('correct');
                    
                    // Disable inputs
                    const allOptions = document.querySelectorAll(`input[name="q${questionNumber}"]`);
                    allOptions.forEach(opt => opt.disabled = true);
                    
                    feedbackEl.innerHTML = `<span class="text-green-600">Bonne réponse !</span>`;
                    questionResults[questionNumber - 1] = true;
                    
                    // Change button to Suivant
                    submitBtn.textContent = 'Suivant';
                    submitBtn.dataset.state = 'next';
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                } else {
                    const selectedLabel = document.querySelector(`input[name="q${questionNumber}"]:checked`).parentElement;
                    selectedLabel.classList.add('wrong');
                    feedbackEl.innerHTML = `<span class="text-red-500">Mauvaise réponse.</span>`;
                    
                    // Allow retry - uncheck after short delay so user can select again, or just let them change selection
                    // Here we just leave it so they can see what was wrong, but they can select another one.
                    const options = document.querySelectorAll(`input[name="q${questionNumber}"]`);
                    options.forEach(opt => {
                        opt.addEventListener('click', () => {
                             selectedLabel.classList.remove('wrong'); // remove red from previous
                        }, {once:true});
                    });
                }
            } 
            // --- Dictation Logic ---
            else {
                if (isCorrect) {
                    // Disable keyboard
                    const jamoKeys = document.getElementById(`jamo-bank-${questionNumber}`).querySelectorAll('.jamo-key');
                    jamoKeys.forEach(k => k.disabled = true);

                    feedbackEl.innerHTML = `<span class="text-green-600">Bonne réponse !</span>`;
                    questionResults[questionNumber - 1] = true;

                    // Change button to Suivant
                    submitBtn.textContent = 'Suivant';
                    submitBtn.dataset.state = 'next';
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');

                } else {
                    dictationAttempts[questionNumber]++;
                    const attempts = dictationAttempts[questionNumber];

                    if (attempts < 3) {
                        feedbackEl.innerHTML = `<span class="text-red-500">Mauvaise réponse.</span>`;
                        // Clear inputs
                        const state = dictationState[questionNumber];
                        state.inputs = Array.from({ length: data.answer.length }, () => []);
                        updateDictationDisplay(questionNumber);
                        setActiveSyllable(questionNumber, 0);
                        
                    } else {
                        // 3rd Failure: Show Answer
                        feedbackEl.innerHTML = `<span class="text-red-600 font-bold">Réponse : ${data.answer}</span>`;
                        
                        // Clear inputs so user can type the answer
                        const state = dictationState[questionNumber];
                        state.inputs = Array.from({ length: data.answer.length }, () => []);
                        updateDictationDisplay(questionNumber);
                        setActiveSyllable(questionNumber, 0);

                        // User must type answer then click check again.
                    }
                }
            }
        }

        function goToNext(questionNumber) {
            if (questionNumber < totalQuestions) {
                showPage(`quiz-page-${questionNumber + 1}`);
            } else {
                showResults();
            }
        }

        function showResults() {
            const score = questionResults.filter(Boolean).length;
            document.getElementById('score-display').textContent = `${score} / ${totalQuestions}`;
            
            const messageEl = document.getElementById('score-message');
            
            if (score === 20) messageEl.textContent = "Parfait !";
            else if (score >= 17) messageEl.textContent = "Bien joué !";
            else if (score >= 13) messageEl.textContent = "Pas mal !";
            else if (score >= 10) messageEl.textContent = "Courage !";
            else messageEl.textContent = "Bon travail.";

            showPage('results-page');
            
            // Send completion message immediately
            if (window.parent) {
                window.parent.postMessage({ type: 'lesson_complete' }, '*');
            }
        }

        function retakeQuiz() {
            questionResults.fill(false);
            dictationState = {};
            dictationAttempts = {}; 
            
            const container = document.querySelector('.course-container');
            container.innerHTML = `
                <div id="page-0" class="page active">
                    <div class="page-content">
                        <h1 class="title-text font-bold text-gray-800 mb-6">Chapitre 8 - Récapitulatif</h1>
                        <p class="lesson-text text-gray-600">Vérifiez ce que vous avez appris au Chapitre 8.<br>C'est un test composé de 20 questions.</p>
                        <button onclick="showPage('quiz-page-1')" class="nav-button bg-blue-600 text-white hover:bg-blue-700 mt-10">Commencer le test</button>
                    </div>
                    <div></div>
                </div>`;
            initializeQuiz();
            
            document.querySelectorAll('[id$="-nav"]').forEach(nav => {
                initialNavStates[nav.id] = nav.innerHTML;
            });
        }
        
        function addOptionListeners() {
             document.querySelectorAll('input[type="radio"]').forEach(radio => {
                 radio.addEventListener('change', (e) => {
                     if (e.target.disabled) return;
                     document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(opt => opt.parentElement.classList.remove('selected'));
                     if(e.target.checked) e.target.parentElement.classList.add('selected');
                 });
             });
        }
        
        function setupDictationQuiz(quizNum) {
            const data = quizData[quizNum - 1];
            const inputContainer = document.getElementById(`input-zone-${quizNum}`);
            const jamoBank = document.getElementById(`jamo-bank-${quizNum}`);
            if (!inputContainer || !jamoBank) return;

            inputContainer.innerHTML = '';
            const numSyllables = data.answer.length;
            for (let i = 0; i < numSyllables; i++) {
                const syllableInput = document.createElement('div');
                syllableInput.className = 'syllable-input';
                syllableInput.dataset.syllableIndex = i;
                syllableInput.onclick = () => setActiveSyllable(quizNum, i);
                inputContainer.appendChild(syllableInput);
            }

            dictationState[quizNum] = { 
                inputs: Array.from({ length: numSyllables }, () => []), 
                isShifted: false, 
                syllableInputs: inputContainer.querySelectorAll('.syllable-input'),
                jamoBank: jamoBank,
                activeSyllableIndex: 0
            };
            setActiveSyllable(quizNum, 0);
            renderKeyboard(quizNum);
        }

        function setActiveSyllable(quizNum, syllableIndex) {
            dictationState[quizNum].activeSyllableIndex = syllableIndex;
            dictationState[quizNum].syllableInputs.forEach((inputEl, index) => {
                inputEl.style.borderColor = (index === syllableIndex) ? '#3b82f6' : '#d1d5db';
            });
        }

        function renderKeyboard(quizNum) {
            const { jamoBank, isShifted } = dictationState[quizNum];
            if (!jamoBank) return;
            jamoBank.innerHTML = ''; 

            const jamoLayout = {
                unshifted: [['ㅂ', 'ㅈ', 'ㄷ', 'ㄱ', 'ㅅ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅐ', 'ㅔ'], ['ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ'], ['ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ']],
                shifted: [['ㅃ', 'ㅉ', 'ㄸ', 'ㄲ', 'ㅆ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅒ', 'ㅖ'], ['ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ'], ['ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ']]
            };
            const currentLayout = isShifted ? jamoLayout.shifted : jamoLayout.unshifted;

            currentLayout.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = 'jamo-row';
                row.forEach(jamo => {
                    const key = document.createElement('button');
                    key.className = 'jamo-key';
                    key.textContent = jamo;
                    key.onclick = () => processJamo(quizNum, jamo);
                    rowEl.appendChild(key);
                });
                jamoBank.appendChild(rowEl);
            });

            const controlRow = document.createElement('div');
            controlRow.className = 'jamo-row';
            const shiftKey = document.createElement('button');
            shiftKey.className = 'jamo-key';
            shiftKey.textContent = '⇧';
            shiftKey.style.flex = '2'; 
            if (isShifted) {
                shiftKey.style.backgroundColor = '#dbeafe';
                shiftKey.style.borderColor = '#93c5fd';
            }
            shiftKey.onclick = () => {
                dictationState[quizNum].isShifted = !dictationState[quizNum].isShifted;
                renderKeyboard(quizNum);
            };
            const deleteKey = document.createElement('button');
            deleteKey.className = 'jamo-key';
            deleteKey.textContent = '←';
            deleteKey.style.flex = '2'; 
            deleteKey.onclick = () => processJamo(quizNum, 'DELETE');
            
            controlRow.appendChild(shiftKey);
            controlRow.appendChild(deleteKey);
            jamoBank.appendChild(controlRow);
        }

        function processJamo(quizNum, jamo) {
            const state = dictationState[quizNum];
            if (!state) return;
            
            // Check if input is disabled (on correct answer)
            if (document.getElementById(`submit-btn-${quizNum}`).dataset.state === 'next') return;

            const currentJamoArray = state.inputs[state.activeSyllableIndex];
            if (jamo === 'DELETE') {
                currentJamoArray.pop();
            } else {
                if (currentJamoArray.length < 3) currentJamoArray.push(jamo);
            }
            updateDictationDisplay(quizNum);
            if (state.isShifted && jamo !== 'DELETE') {
                state.isShifted = false;
                renderKeyboard(quizNum);
            }
        }

        function combineHangeul(jamoArray) {
            if (!jamoArray || jamoArray.length === 0) return '';
            const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
            const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
            const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
            let cho = CHO.indexOf(jamoArray[0]);
            if (cho === -1) return jamoArray.join('');
            let jung = -1, jong = 0;
            if (jamoArray.length > 1) jung = JUNG.indexOf(jamoArray[1]);
            else return jamoArray.join('');
            if (jung === -1) return jamoArray.join('');
            if (jamoArray.length > 2) jong = JONG.indexOf(jamoArray[2]);
            if (jong === -1) jong = 0;
            return String.fromCharCode(0xAC00 + (cho * 21 * 28) + (jung * 28) + jong);
        }

        function updateDictationDisplay(quizNum) {
            const state = dictationState[quizNum];
            if (!state) return;
            state.syllableInputs.forEach((inputEl, index) => {
                inputEl.textContent = combineHangeul(state.inputs[index]);
            });
        }

        function initializeQuiz() {
            createQuizPages();
            addOptionListeners();
            quizData.forEach((data, index) => {
                if (data.type === 'dictation') {
                    setupDictationQuiz(index + 1);
                }
            });
        }
        
        // Physical Keyboard Support: Allow INPUT ONLY if keyboard language is Korean (Hangul)
        document.addEventListener('keydown', (e) => {
            if (!currentPageId.startsWith('quiz-page-')) return;
            
            const questionNumber = parseInt(currentPageId.replace('quiz-page-', ''), 10);
            const data = quizData[questionNumber - 1];
            
            if (data && data.type === 'dictation') {
                if (e.key === 'Backspace') {
                    processJamo(questionNumber, 'DELETE');
                    return;
                }
                
                // Allow ONLY valid Hangul Jamos. 
                // This forces the user to switch their input method to Korean.
                // QWERTY/AZERTY English characters will be ignored.
                if (validJamos.includes(e.key)) {
                    processJamo(questionNumber, e.key);
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeQuiz();
            document.querySelectorAll('[id$="-nav"]').forEach(nav => {
                initialNavStates[nav.id] = nav.innerHTML;
            });
            showPage('page-0');
        });

    </script>
</body>
</html>
