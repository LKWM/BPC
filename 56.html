<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chapitre 9 - Récapitulatif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --font-sm: clamp(0.75rem, 2vmin, 0.875rem);
            --font-base: clamp(0.875rem, 2.5vmin, 1rem);
            --font-lg: clamp(1rem, 3vmin, 1.25rem);
            --font-xl: clamp(1.125rem, 4vmin, 1.5rem);
            --font-title: clamp(1.5rem, 5vmin, 2rem);
            --padding-sm: clamp(0.5rem, 2vmin, 0.75rem);
            --padding-md: clamp(0.75rem, 3vmin, 1.5rem);
            --padding-lg: clamp(1rem, 4vmin, 2.5rem);
        }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 1rem; background-color: #f3f4f6;
        }

        .course-wrapper {
            width: 100%;
            max-width: 600px;
        }
        .course-container {
            width: 100%;
            position: relative;
            aspect-ratio: 1 / 1;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;
            background-color: white; padding: var(--padding-lg);
            border-radius: 0.75rem;
            box-sizing: border-box; /* [추가됨] 패딩 계산 일관성 보장 */
        }
        #page-0 {
            justify-content: center;
        }
        #page-0 .page-content {
            flex-grow: 0;
        }
        .page.active { opacity: 1; visibility: visible; }
        .page-content {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        @media (max-width: 600px) {
            body { padding: 0; height: 100vh; max-height: -webkit-fill-available; }
            .course-wrapper { height: 100%; max-width: 100%; }
            .course-container { aspect-ratio: auto; height: 100%; border-radius: 0; }
            .page { padding: 1.5rem 1rem; border-radius: 0; }
        }

        .title-text { font-size: var(--font-title); }
        .lesson-text { font-size: var(--font-lg); }
        .nav-button { padding: var(--padding-sm) var(--padding-md); border-radius: 0.5rem; font-weight: 600; font-size: var(--font-base); transition: background-color 0.2s; }
        .page-header {
            text-align: center; color: #4b5563; font-size: var(--font-lg);
            font-weight: 600; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem; flex-shrink: 0;
        }
        .audio-button { background: none; border: none; cursor: pointer; }
        .audio-icon { width: 3rem; height: 3rem; color: #6b7280; transition: color 0.2s; }
        .audio-button:hover .audio-icon { color: #1d4ed8; }

        .quiz-question { font-size: var(--font-lg); font-weight: 600; margin-bottom: 1rem; }
        .quiz-prompt { font-weight: 700; font-size: var(--font-title); color: #374151; margin-bottom: 1rem; font-family: 'Noto Sans KR', sans-serif; min-height: 50px;}
        .quiz-option {
            display: inline-flex; align-items: center; justify-content: center;
            padding: var(--padding-sm) var(--padding-md);
            border: 2px solid #d1d5db; border-radius: 0.5rem; margin: 0.25rem;
            cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
            font-family: 'Noto Sans KR', sans-serif; text-align: center;
        }
        .quiz-option span { font-size: var(--font-xl); }
        .quiz-option:hover { background-color: #f3f4f6; }
        .quiz-option.selected { background-color: #e0e7ff; border-color: #a5b4fc; }
        .quiz-option input { display: none; }
        .feedback-area {
            text-align: right; /* [수정됨] 피드백 정렬 */
            min-height: 40px; /* [수정됨] 높이 일관성 */
            display: flex;
            align-items: center; justify-content: flex-end; /* [수정됨] 피드백 정렬 */
            gap: 0.5rem; /* [추가됨] 버튼과의 간격 */
        }
        
        .input-zone-container { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; min-height: clamp(60px, 20vmin, 80px); gap: 0.5rem;}
        .syllable-input {
            border: 2px solid #cbd5e1; background-color: #f9fafb;
            width: clamp(60px, 20vmin, 80px); height: clamp(60px, 20vmin, 80px);
            font-size: clamp(2rem, 10vmin, 3rem);
            font-family: 'Noto Sans KR', sans-serif; font-weight: 700;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: border-color 0.2s;
            border-radius: 0.5rem; /* [추가됨] */
        }
        /* [추가됨] 활성 입력 상자 스타일 */
        .syllable-input.active {
            border-color: #3b82f6;
        }
        .jamo-bank { display: flex; flex-direction: column; gap: 4px; /* [수정됨] 간격 */ justify-content: center; width: 100%; max-width: 500px; padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-top: 1rem; align-items: center; }
        .jamo-row { display: flex; flex-wrap: nowrap; gap: 4px; /* [수정됨] 간격 */ justify-content: center; width: 100%; }
        .jamo-key {
            height: clamp(35px, 8vmin, 45px); /* [수정됨] 키보드 높이 */
            font-size: var(--font-jamo-key); /* [수정됨] CSS 변수 사용 */
            font-family: 'Noto Sans KR', sans-serif; 
            border: 1px solid #d1d5db; border-bottom-width: 3px; /* [수정됨] 입체감 */
            border-radius: 0.375rem; /* [수정됨] */
            background-color: #ffffff; /* [수정됨] */
            cursor: pointer; display:flex; align-items:center; justify-content:center;
            flex: 1; min-width: 0;
            transition: background-color 0.1s, border-color 0.1s, transform 0.1s; /* [추가됨] */
            -webkit-tap-highlight-color: transparent; /* [추가됨] */
        }
        .jamo-key:hover { background-color: #f9fafb; } /* [수정됨] */
        /* [추가됨] 키 클릭 효과 */
        .jamo-key:active {
            background-color: #e5e7eb;
            border-bottom-width: 1px;
            transform: translateY(2px);
        }
        /* [추가됨] 컨트롤 키 스타일 */
        .control-key {
            flex: 2;
        }
        .shift-key.active {
            background-color: #dbeafe;
            border-color: #93c5fd;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="course-wrapper">
        <div class="course-container">
            
            <div id="page-0" class="page active">
                <div class="page-content">
                    <h1 class="title-text font-bold text-gray-800 mb-6 leading-tight">Chapitre 9 - Récapitulatif</h1>
                    <p class="lesson-text text-gray-600">Vérifiez ce que vous avez appris au Chapitre 9.<br>C'est un test composé de 20 questions.</p>
                    <button onclick="showPage('quiz-page-1')" class="nav-button bg-blue-600 text-white hover:bg-blue-700 mt-10">Commencer le test</button>
                </div>
                <div></div>
            </div>

            <!-- QUIZ AND RESULT PAGES WILL BE GENERATED HERE -->

        </div>
    </div>
    
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="audio-icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
        </symbol>
    </svg>

    <script>
        let currentPageId = 'page-0';
        const totalQuestions = 20;
        let questionResults = new Array(totalQuestions).fill(false);
        let dictationState = {}; // { quizNum: { inputs: [[]], isShifted: false, ... } }
        let navInitialStates = {}; // 하단 네비게이션바 초기 상태 저장

        const sounds = {
            'gam': { file: 'https://static.wixstatic.com/mp3/699687_023f3517caaf417985825a6f1ffc2928.mp3' },
            'tal': { file: 'https://static.wixstatic.com/mp3/699687_15d3e451e8ec4333a648d7320fcc05ab.mp3' },
            'mun': { file: 'https://static.wixstatic.com/mp3/699687_ba3cbab7c5564a5790edb89f3c9ad2d5.mp3' },
            'chang': { file: 'https://static.wixstatic.com/mp3/699687_7ba0d1da2caf4bbbac35378f049ff0e6.mp3' },
            'bom': { file: 'https://static.wixstatic.com/mp3/699687_0f8b1278611346d0a048ef5ea8d5e05e.mp3' },
            'yeonghwa': { file: 'https://static.wixstatic.com/mp3/699687_690073b12fce4ec69779a69eb4543160.mp3' },
            'jongi': { file: 'https://static.wixstatic.com/mp3/699687_221fcc2e070c48b58bc39daaaded8356.mp3' },
            'namu': { file: 'https://static.wixstatic.com/mp3/699687_8b95668f1d944283b80dea27b3d48f8d.mp3' },
            'kkaji': { file: 'https://static.wixstatic.com/mp3/699687_3a900e5abb6940d48fad2568d64edadf.mp3' },
            'swida': { file: 'https://static.wixstatic.com/mp3/699687_027ca43bbb55488ca464dae0b0d6907a.mp3' },
            'ma': { file: 'https://static.wixstatic.com/mp3/699687_a97f6a1309a9494b8be961e0f5666c56.mp3' },
            'jong': { file: 'https://static.wixstatic.com/mp3/699687_1f37c39b0a0d4dffb18877e5a34f65c4.mp3' },
            'gong': { file: 'https://static.wixstatic.com/mp3/699687_8392306375964831bd7e254e283d7ab8.mp3' },
            'saem': { file: 'https://static.wixstatic.com/mp3/699687_1f34a2922b1c423c846381403fdc6bd2.mp3' },
            'tol': { file: 'https://static.wixstatic.com/mp3/699687_503118e7e8e4469a8eb3994dc5d93b17.mp3' },
            'mal': { file: 'https://static.wixstatic.com/mp3/699687_62ae5f30cbf14749806d28bd351ba42f.mp3' },
            'gang': { file: 'https://static.wixstatic.com/mp3/699687_44c30ee2cd9e42ff8eb001f66a0b44f3.mp3' },
            'bang': { file: 'https://static.wixstatic.com/mp3/699687_c065955a571544588c47617c39f40b55.mp3' },
            'sigye': { file: 'https://static.wixstatic.com/mp3/699687_c3d5010c86fa4e00b3f58c75ac6e9c2a.mp3' },
            'dosi': { file: 'https://static.wixstatic.com/mp3/699687_1d0912a8fc5646e1ac36d590310dc1a8.mp3' },
            'sik': { file: 'https://static.wixstatic.com/mp3/699687_d8c099e4ecc0469c85bec831cc949ad1.mp3' },
            'got': { file: 'https://static.wixstatic.com/mp3/699687_ba5f066855b9440eb4d1b12d74fa784a.mp3' },
            'nat': { file: 'https://static.wixstatic.com/mp3/699687_503cf5de08004768baf7166bf163f0c3.mp3' },
            'il': { file: 'https://static.wixstatic.com/mp3/699687_4b8d3d7598b141d2b5377226ab112a96.mp3' },
            'sup': { file: 'https://static.wixstatic.com/mp3/699687_550cee9474ac4edf9280939ee45559e3.mp3' },
            'bit': { file: 'https://static.wixstatic.com/mp3/699687_235d36ac07244f64a5aede05cfe4d8ff.mp3' },
            'kkot': { file: 'https://static.wixstatic.com/mp3/699687_793e7647c0f8487fa8ee0cd1479e5083.mp3' },
            'seonsaengnim': { file: 'https://static.wixstatic.com/mp3/699687_986518d8597f4b539d028283dce31765.mp3' },
            'baji': { file: 'https://static.wixstatic.com/mp3/699687_62be60a8dc6945a9a90b26e532f450d3.mp3' },
            'byeongwon': { file: 'https://static.wixstatic.com/mp3/699687_864a5b7957db4083bea18f0e4b05b12e.mp3' },
            'chimdae': { file: 'https://static.wixstatic.com/mp3/699687_ddca22abc9bf425c804f26ef7d0a27cb.mp3' }
        };
        
        const quizData = [
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['감', '갑', '갚'], answer: '감' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['읻', '있', '익'], answer: '익' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['공', '곸', '곡'], answer: '공' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['봇', '봍', '볼'], answer: '볼' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['잗', '잨', '잫'], answer: '잨' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['밖', '반', '박'], answer: '반' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['헛', '헡', '헙', '헛'], answer: '헙' },
            { type: 'mcq', question: 'Cherchez un caractère qui se prononce différemment des autres.', options: ['챀', '착', '찬', '찪'], answer: '찬' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'sik', options: ['십', '식', '신', '싣'], answer: '식' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'bom', options: ['몹', '봄', '본', '몸'], answer: '봄' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'got', options: ['곤', '곧', '곱', '골', '곡'], answer: '곧' },
            { type: 'mcq', question: 'Choisissez la bonne syllabe.', audio: 'nat', options: ['나', '낳', '난', '남', '낙'], answer: '낳' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'byeongwon', prompt: '병_', options: ['운', '원', '욱', '웍'], answer: '원' },
            { type: 'mcq-fill', question: 'Complétez le blanc.', audio: 'chimdae', prompt: '__대', options: ['짐', '침', '진', '친', '집', '칩'], answer: '침' },
            { type: 'dictation', audio: 'il', answer: ['일'] },
            { type: 'dictation', audio: 'sup', answer: ['숲', '숩'] },
            { type: 'dictation', audio: 'bit', answer: ['빛', '빚', '빗', '빘', '빟', '빋', '빝'] },
            { type: 'dictation', audio: 'kkot', answer: ['꽃', '꼳', '꽅', '꽂', '꽇', '꼿'] },
            { type: 'dictation', audio: 'seonsaengnim', answer: ['선생님'] },
            { type: 'dictation', audio: 'baji', answer: ['바지'] }
        ];

        // --- Hangeul Logic (Simplified) ---
        const HANGEUL_OFFSET = 0xAC00;
        const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
        const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        
        function combineHangeul(jamoArray) {
            if (!jamoArray || jamoArray.length === 0) return '';
            let cho = CHO.indexOf(jamoArray[0]);
            if (cho === -1) return jamoArray.join('');
            let jung = -1, jong = 0;
            if (jamoArray.length > 1) jung = JUNG.indexOf(jamoArray[1]);
            else return jamoArray.join('');
            if (jung === -1) return jamoArray.join('');
            if (jamoArray.length > 2) jong = JONG.indexOf(jamoArray[2]);
            if (jong === -1) jong = 0;
            return String.fromCharCode(HANGEUL_OFFSET + (cho * 21 * 28) + (jung * 28) + jong);
        }
        // --- End Hangeul Logic ---

        function createQuizPages() {
            const container = document.querySelector('.course-container');
            let pagesHtml = '';

            quizData.forEach((data, index) => {
                const questionNumber = index + 1;
                let contentHtml = '';

                if (data.type.startsWith('mcq')) {
                    contentHtml = `
                        <p class="quiz-question">${data.question}</p>
                        ${data.prompt ? `<p class="quiz-prompt">${data.prompt}</p>` : ''}
                        ${data.audio ? `<button class="audio-button" onclick="playSound('${data.audio}')"><svg class="audio-icon mx-auto"><use href="#audio-icon-svg"/></svg></button>` : ''}
                        <div class="flex flex-wrap justify-center gap-2">
                        ${data.options.map(opt => `<label class="quiz-option"><span>${opt}</span><input type="radio" name="q${questionNumber}" value="${opt}"></label>`).join('')}
                        </div>
                    `;
                } else { // dictation
                    contentHtml = `
                        <p class="quiz-question">Écrivez en coréen.</p>
                        <button class="audio-button" onclick="playSound('${data.audio}')"><svg class="audio-icon mx-auto"><use href="#audio-icon-svg"/></svg></button>
                        <div class="input-zone-container" id="input-zone-${questionNumber}"></div>
                        <div class="jamo-bank" id="jamo-bank-${questionNumber}"></div>
                    `;
                }

                const nextButtonText = questionNumber === totalQuestions ? 'Terminer le test' : 'Suivant &rarr;';
                const prevButtonHtml = questionNumber > 1 ? `<button onclick="showPage('quiz-page-${questionNumber - 1}')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button>` : `<div class="w-24"></div>`; // Placeholder for alignment

                const navButtonHtml = `
                    <div id="quiz-${questionNumber}-nav" class="flex justify-between items-center w-full">
                        ${prevButtonHtml}
                        <div class="flex items-center gap-4">
                           <div id="q${questionNumber}-feedback" class="feedback-area"></div>
                           <button onclick="submitAnswerAndProceed(${questionNumber})" class="nav-button text-white bg-blue-600 hover:bg-blue-700">${nextButtonText}</button>
                        </div>
                    </div>`;

                pagesHtml += `
                    <div id="quiz-page-${questionNumber}" class="page">
                        <div class="page-header w-full">${questionNumber} / ${totalQuestions}</div>
                        <div class="page-content flex flex-col justify-center items-center">
                            ${contentHtml}
                        </div>
                        ${navButtonHtml}
                    </div>
                `;
            });
            
            pagesHtml += `
                <div id="results-page" class="page items-center justify-center text-center">
                    <div class="page-content flex flex-col items-center justify-center">
                        <h2 class="title-text font-bold text-gray-800 mb-4">Résultats du test</h2>
                        <p id="score-display" class="text-5xl font-bold text-blue-600 mb-6"></p>
                        <p id="score-message" class="lesson-text text-gray-600"></p>
                    </div>
                    <div class="flex justify-center items-center gap-4">
                        <button onclick="retakeQuiz()" class="nav-button bg-gray-500 text-white hover:bg-gray-600">Réessayer</button>
                        <button id="finish-button" onclick="showPage('final-completion-message')" class="nav-button bg-green-600 text-white hover:bg-green-700 hidden">Terminer</button>
                    </div>
                </div>
                <div id="final-completion-message" class="page items-center justify-center text-center">
                    <div class="page-content flex flex-col items-center justify-center">
                         <svg class="w-20 h-20 mx-auto mb-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         <h2 class="title-text font-bold text-gray-800 mb-3">Félicitations !</h2>
                         <p class="lesson-text text-gray-600">Vous avez terminé le Chapitre 9.</p>
                    </div>
                    <div class="w-full text-center pb-4">
                         <button onclick="showPage('page-0')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Recommencer</button>
                    </div>
                </div>
            `;

            // Insert after page-0
            document.getElementById('page-0').insertAdjacentHTML('afterend', pagesHtml);
        }

        function playSound(soundKey) {
            if (!sounds[soundKey]) return;
            Tone.start().then(() => {
                const player = new Tone.Player(sounds[soundKey].file).toDestination();
                player.autostart = true;
                player.onstop = () => player.dispose(); // [수정됨] 오디오가 끝나면 플레이어 제거
            });
        }

        // [수정됨] postMessage 로직 추가
        function showPage(pageId) {
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) currentPage.classList.remove('active');
            
            const nextPage = document.getElementById(pageId);
            if (nextPage) {
                nextPage.classList.add('active');
                currentPageId = pageId;

                // [추가됨] 퀴즈 페이지가 아닌 경우, 또는 특정 퀴즈 페이지에서 상태 리셋
                if (pageId.startsWith('quiz-page-')) {
                     // 퀴즈 페이지로 이동할 때 특별한 로직이 필요하면 여기에 추가
                     // (예: 오디오 자동 재생 - 현재는 필요 없음)
                } else if (pageId === 'final-completion-message') {
                     // [추가됨] 최종 완료 페이지에서 postMessage 전송
                    if (window.parent) {
                        window.parent.postMessage({ type: 'lesson_complete' }, '*');
                    }
                } else if (pageId === 'page-0') {
                    // [추가됨] 타이틀 페이지로 돌아갈 때, 퀴즈 리셋 (다시하기를 누르지 않은 경우 대비)
                    retakeQuiz(false); // false: 페이지 전환 없음
                }
            }
        }

        function submitAnswerAndProceed(questionNumber) {
            const data = quizData[questionNumber - 1];
            let isAnswered = false;
            let userAnswer = null;

            if (data.type.startsWith('mcq')) {
                const selectedOption = document.querySelector(`input[name="q${questionNumber}"]:checked`);
                if (selectedOption) {
                    userAnswer = selectedOption.value;
                    isAnswered = true;
                }
            } else { // dictation
                const state = dictationState[questionNumber];
                if (state) {
                    userAnswer = state.inputs.map(syllableArray => combineHangeul(syllableArray)).join('');
                    if (userAnswer) { // [수정됨] 빈칸이 아닌지 확인
                        isAnswered = true; 
                    }
                }
            }
            
            if (!isAnswered) {
                 const feedbackEl = document.getElementById(`q${questionNumber}-feedback`);
                 if(feedbackEl) {
                    feedbackEl.innerHTML = `<p class="text-yellow-600 font-bold" style="font-size: var(--font-base);">Veuillez répondre.</p>`; // [수정됨] 폰트 크기 적용
                    setTimeout(() => { if(feedbackEl) feedbackEl.innerHTML = ''; }, 2000);
                 }
                 return;
            }

            const correctAnswer = data.answer;
            if (Array.isArray(correctAnswer)) {
                questionResults[questionNumber - 1] = correctAnswer.includes(userAnswer);
            } else {
                questionResults[questionNumber - 1] = (userAnswer === correctAnswer);
            }

            // [수정됨] 피드백 영역 클리어
            const feedbackEl = document.getElementById(`q${questionNumber}-feedback`);
            if(feedbackEl) feedbackEl.innerHTML = '';

            if (questionNumber < totalQuestions) {
                showPage(`quiz-page-${questionNumber + 1}`);
            } else {
                showResults();
            }
        }

        function showResults() {
            const score = questionResults.filter(Boolean).length;
            document.getElementById('score-display').textContent = `${score} / ${totalQuestions}`;
            
            const messageEl = document.getElementById('score-message');
            const finishButton = document.getElementById('finish-button');
            
            if (score === 20) messageEl.textContent = "Très bien ! Êtes-vous prêt(e) pour la suite ?";
            else if (score >= 17) messageEl.textContent = "Bien joué ! Vous y êtes presque !";
            else if (score >= 13) messageEl.textContent = "Bien joué ! Entraînons-nous encore un peu.";
            else if (score >= 10) messageEl.textContent = "Bien joué ! Essayez de revoir la leçon.";
            else messageEl.textContent = "Bon travail. Essayez de revoir la leçon et de refaire le test.";

            if (score >= 17) finishButton.classList.remove('hidden');
            else finishButton.classList.add('hidden');

            showPage('results-page');
        }

        // [수정됨] retakeQuiz 로직 수정
        function retakeQuiz(navigateToPage0 = true) {
            questionResults.fill(false);
            dictationState = {};
            
            // DOM을 완전히 재생성하는 대신, 기존 퀴즈 페이지를 리셋
            quizData.forEach((data, index) => {
                const qNum = index + 1;
                const page = document.getElementById(`quiz-page-${qNum}`);
                if (!page) return;

                // MCQ 리셋
                if (data.type.startsWith('mcq')) {
                    const options = page.querySelectorAll(`input[name="q${qNum}"]`);
                    options.forEach(opt => {
                        opt.checked = false;
                        opt.parentElement.classList.remove('selected');
                    });
                }
                // Dictation 리셋
                else if (data.type === 'dictation') {
                    setupDictationQuiz(qNum); // setup이 리셋 로직을 포함
                }
                
                // 네비게이션 바 리셋
                const navEl = document.getElementById(`quiz-${qNum}-nav`);
                if (navEl && navInitialStates[navEl.id]) {
                    navEl.innerHTML = navInitialStates[navEl.id];
                    // 버튼 이벤트 다시 바인딩
                    const nextButton = navEl.querySelector('button[onclick^="submitAnswer"]');
                    if (nextButton) {
                        nextButton.onclick = () => submitAnswerAndProceed(qNum);
                    }
                    const prevButton = navEl.querySelector('button[onclick^="showPage"]');
                    if (prevButton) {
                        const prevPageId = qNum > 1 ? `quiz-page-${qNum - 1}` : 'page-0';
                        prevButton.onclick = () => showPage(prevPageId);
                    }
                }
            });

            // 점수판 리셋
            document.getElementById('score-display').textContent = '';
            document.getElementById('score-message').textContent = '';
            document.getElementById('finish-button').classList.add('hidden');
            
            if (navigateToPage0) {
                showPage('page-0');
            }
        }
        
        function addOptionListeners() {
             document.querySelectorAll('input[type="radio"]').forEach(radio => {
                 radio.addEventListener('change', (e) => {
                     document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(opt => opt.parentElement.classList.remove('selected'));
                     if(e.target.checked) e.target.parentElement.classList.add('selected');
                 });
             });
        }
        
        // --- Dictation Logic (개선됨) ---
        function setupDictationQuiz(quizNum) {
            const data = quizData[quizNum - 1];
            const inputContainer = document.getElementById(`input-zone-${quizNum}`);
            const jamoBank = document.getElementById(`jamo-bank-${quizNum}`);
            if (!inputContainer || !jamoBank) return;

            inputContainer.innerHTML = '';
            const answerWord = Array.isArray(data.answer) ? data.answer[0] : data.answer;
            const numSyllables = answerWord.length;

            for (let i = 0; i < numSyllables; i++) {
                const syllableInput = document.createElement('div');
                syllableInput.className = 'syllable-input';
                syllableInput.dataset.syllableIndex = i;
                syllableInput.onclick = () => setActiveSyllable(quizNum, i);
                inputContainer.appendChild(syllableInput);
            }

            dictationState[quizNum] = { 
                inputs: Array.from({ length: numSyllables }, () => []), 
                isShifted: false, 
                syllableInputs: inputContainer.querySelectorAll('.syllable-input'),
                jamoBank: jamoBank,
                activeSyllableIndex: 0
            };
            setActiveSyllable(quizNum, 0);
            renderKeyboard(quizNum);
        }

        function setActiveSyllable(quizNum, syllableIndex) {
            dictationState[quizNum].activeSyllableIndex = syllableIndex;
            dictationState[quizNum].syllableInputs.forEach((inputEl, index) => {
                inputEl.classList.toggle('active', index === syllableIndex); // [수정됨] .active 클래스 사용
            });
        }

        function renderKeyboard(quizNum) {
            const state = dictationState[quizNum];
            if (!state) return;
            const { jamoBank, isShifted } = state;
            if (!jamoBank) return;
            jamoBank.innerHTML = ''; 

            const jamoLayout = {
                unshifted: [['ㅂ', 'ㅈ', 'ㄷ', 'ㄱ', 'ㅅ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅐ', 'ㅔ'], ['ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ'], ['ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ']],
                shifted: [['ㅃ', 'ㅉ', 'ㄸ', 'ㄲ', 'ㅆ', 'ㅛ', 'ㅕ', 'ㅑ', 'ㅒ', 'ㅖ'], ['ㅁ', 'ㄴ', 'ㅇ', 'ㄹ', 'ㅎ', 'ㅗ', 'ㅓ', 'ㅏ', 'ㅣ'], ['ㅋ', 'ㅌ', 'ㅊ', 'ㅍ', 'ㅠ', 'ㅜ', 'ㅡ']]
            };
            const currentLayout = isShifted ? jamoLayout.shifted : jamoLayout.unshifted;

            currentLayout.forEach(row => {
                const rowEl = document.createElement('div');
                rowEl.className = 'jamo-row';
                row.forEach(jamo => {
                    const key = document.createElement('button');
                    key.className = 'jamo-key';
                    key.textContent = jamo;
                    key.onclick = () => processJamo(quizNum, jamo);
                    rowEl.appendChild(key);
                });
                jamoBank.appendChild(rowEl);
            });

            const controlRow = document.createElement('div');
            controlRow.className = 'jamo-row';
            const shiftKey = document.createElement('button');
            shiftKey.className = 'jamo-key control-key shift-key';
            shiftKey.textContent = '⇧';
            if (isShifted) {
                shiftKey.classList.add('active');
            }
            shiftKey.onclick = () => {
                dictationState[quizNum].isShifted = !dictationState[quizNum].isShifted;
                renderKeyboard(quizNum);
            };
            const deleteKey = document.createElement('button');
            deleteKey.className = 'jamo-key control-key';
            deleteKey.textContent = '←';
            deleteKey.onclick = () => processJamo(quizNum, 'DELETE');
            
            controlRow.appendChild(shiftKey);
            controlRow.appendChild(deleteKey);
            jamoBank.appendChild(controlRow);
        }

        function processJamo(quizNum, jamo) {
            const state = dictationState[quizNum];
            if (!state) return; // [추가됨] 방어 코드
            const currentJamoArray = state.inputs[state.activeSyllableIndex];
            if (jamo === 'DELETE') {
                currentJamoArray.pop();
            } else {
                // [수정됨] 한글 조합 로직 단순화 (최대 3개 자모)
                if (currentJamoArray.length < 3) currentJamoArray.push(jamo);
            }
            updateDictationDisplay(quizNum);
            if (state.isShifted && jamo !== 'DELETE') {
                state.isShifted = false;
                renderKeyboard(quizNum);
            }
        }

        function updateDictationDisplay(quizNum) {
            const state = dictationState[quizNum];
            if (!state) return; // [추가됨] 방어 코드
            state.syllableInputs.forEach((inputEl, index) => {
                inputEl.textContent = combineHangeul(state.inputs[index]);
            });
        }

        function initializeQuiz() {
            createQuizPages();
            addOptionListeners();
            quizData.forEach((data, index) => {
                if (data.type === 'dictation') {
                    setupDictationQuiz(index + 1);
                }
            });
            // [추가됨] 네비게이션 초기 상태 저장
            document.querySelectorAll('[id^="quiz-"][id$="-nav"]').forEach(nav => {
                navInitialStates[nav.id] = nav.innerHTML;
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeQuiz();
            showPage('page-0');
        });

    </script>
</body>
</html>
