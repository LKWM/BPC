<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chapitre 8 - Les consonnes finales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --font-sm: clamp(0.75rem, 2vmin, 0.875rem);
            --font-base: clamp(0.875rem, 2.5vmin, 1rem);
            --font-lg: clamp(1rem, 3vmin, 1.25rem);
            --font-xl: clamp(1.125rem, 4vmin, 1.5rem);
            --font-title: clamp(1.5rem, 5vmin, 2rem);
            --font-display: clamp(5rem, 20vmin, 8rem);
            --font-char-btn: clamp(4rem, 15vmin, 5rem);
            --font-jamo-key: clamp(0.8rem, 2.5vmin, 1rem);
            --padding-sm: clamp(0.5rem, 2vmin, 0.75rem);
            --padding-md: clamp(0.75rem, 3vmin, 1.5rem);
            --padding-lg: clamp(1rem, 4vmin, 2.5rem);
        }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; padding: 1rem; background-color: #f3f4f6;
        }

        /* --- Layout --- */
        .course-wrapper { width: 100%; max-width: 600px; }
        .course-container {
            width: 100%; position: relative; aspect-ratio: 1 / 1;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem; overflow: hidden; background-color: white;
        }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;
            background-color: white; padding: var(--padding-lg); box-sizing: border-box;
        }
        .page.active { opacity: 1; visibility: visible; }
        .page-content {
            flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        
        /* --- Mobile Responsive --- */
        @media (max-width: 600px) {
            body { padding: 0; height: 100vh; max-height: -webkit-fill-available; }
            .course-wrapper { height: 100%; max-width: 100%; }
            .course-container { aspect-ratio: auto; height: 100%; border-radius: 0; }
            .page { padding: 1.5rem 1rem; border-radius: 0; }
        }

        /* --- Common Elements --- */
        .title-text { font-size: var(--font-title); font-weight: 700; text-align: center; }
        .lesson-text { font-size: var(--font-lg); color: #4b5563; line-height: 1.6; }
        .nav-button { padding: var(--padding-sm) var(--padding-md); border-radius: 0.5rem; font-weight: 600; font-size: var(--font-base); transition: background-color 0.2s; }
        .char-button {
            font-size: var(--font-char-btn); font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
            background-color: #eff6ff; border: 2px solid #93c5fd;
            border-radius: 1rem; padding: var(--padding-sm) var(--padding-md);
            cursor: pointer; transition: background-color 0.2s, transform 0.1s;
            line-height: 1.1;
        }
        .char-button:hover { background-color: #dbeafe; }
        .char-button:active { transform: scale(0.95); }

        /* --- Quiz --- */
        .quiz-question { font-weight: 600; font-size: var(--font-lg); color: #1f2937; }
        .audio-button { background: none; border: none; cursor: pointer; }
        .audio-icon { width: clamp(2.5rem, 8vmin, 3rem); height: clamp(2.5rem, 8vmin, 3rem); color: #6b7280; transition: color 0.2s; }
        .audio-button:hover .audio-icon { color: #1d4ed8; }
        .feedback-area { text-align: right; min-height: 52px; display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center;}
        
        /* Writing Quiz */
        .writing-quiz-content { gap: clamp(0.25rem, 1.5vh, 1rem); }
        .syllable-container { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; min-height: clamp(80px, 22vmin, 100px); }
        .syllable-input { 
            border: 2px solid #cbd5e1; background-color: #f9fafb; 
            width: clamp(80px, 22vmin, 100px); height: clamp(80px, 22vmin, 100px); 
            font-size: var(--font-char-btn); font-family: 'Noto Sans KR', sans-serif; 
            font-weight: 700; display: flex; justify-content: center; align-items: center; 
            cursor: pointer; transition: border-color 0.2s; border-radius: 0.5rem;
        }
        .syllable-input.active { border-color: #3b82f6; }
        .jamo-bank { display: flex; flex-direction: column; gap: 4px; justify-content: center; padding: clamp(0.5rem, 1vmin, 0.75rem); border-top: 1px solid #e5e7eb; margin-top: clamp(0.5rem, 2vh, 1rem); align-items: center; width:100%;}
        .jamo-row { display: flex; flex-wrap: nowrap; gap: 4px; justify-content: center; width: 100%; }
        .jamo-key {
            height: clamp(35px, 8vmin, 45px); font-size: var(--font-jamo-key);
            font-family: 'Noto Sans KR', sans-serif; font-weight: 600;
            border: 1px solid #d1d5db; border-bottom-width: 3px;
            border-radius: 0.375rem; background-color: #ffffff;
            cursor: pointer; display:flex; align-items:center; justify-content:center;
            flex-grow: 1; min-width: 0;
            transition: background-color 0.1s, border-color 0.1s, transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .jamo-key:hover { background-color: #f9fafb; }
        .jamo-key:active { background-color: #e5e7eb; border-bottom-width: 1px; transform: translateY(2px);}
        .shift-key { flex-grow: 1.5; }
        .shift-key.active { background-color: #a5b4fc; color: white; border-color: #6366f1;}
        .backspace-key { flex-grow: 1.5; }
    </style>
</head>
<body>

    <div class="course-wrapper">
        <div class="course-container">
            <!-- Content will be generated by JavaScript -->
        </div>
    </div>

    <script>
        let currentPageId = 'page-0';
        let dictationAssemblers = {};
        let activeDictationBox = { quizNum: -1, boxIndex: -1 };
        let isShiftActive = false;
        let initialNavStates = {}; // [ADDED] To store initial nav states for reset

        const sounds = {
            'gang': { file: 'https://static.wixstatic.com/mp3/699687_44c30ee2cd9e42ff8eb001f66a0b44f3.mp3' },
            'bang': { file: 'https://static.wixstatic.com/mp3/699687_c065955a571544588c47617c39f40b55.mp3' },
            'jong': { file: 'https://static.wixstatic.com/mp3/699687_1f37c39b0a0d4dffb18877e5a34f65c4.mp3' },
            'yeonghwa': { file: 'https://static.wixstatic.com/mp3/699687_690073b12fce4ec69779a69eb4543160.mp3' },
        };
        
        const quizData = [
            { id: 1, page: 7, type: 'writing', sound: 'bang', answer: '방', syllables: 1 },
            { id: 2, page: 8, type: 'writing', sound: 'yeonghwa', answer: '영화', syllables: 2 },
        ];
        
        const HANGEUL_OFFSET = 0xAC00;
        const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
        const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        
        const isVowel = (c) => JUNG.includes(c);
        const isConsonant = (c) => CHO.includes(c);
        
        const VOWEL_PAIRS = { 'ㅗ': {'ㅏ': 'ㅘ', 'ㅐ': 'ㅙ', 'ㅣ': 'ㅚ'}, 'ㅜ': {'ㅓ': 'ㅝ', 'ㅔ': 'ㅞ', 'ㅣ': 'ㅟ'}, 'ㅡ': {'ㅣ': 'ㅢ'} };
        const CONSONANT_PAIRS = { 'ㄱ': {'ㅅ': 'ㄳ'}, 'ㄴ': {'ㅈ': 'ㄵ', 'ㅎ': 'ㄶ'}, 'ㄹ': {'ㄱ': 'ㄺ', 'ㅁ': 'ㄻ', 'ㅂ': 'ㄼ', 'ㅅ': 'ㄽ', 'ㅌ': 'ㄾ', 'ㅍ': 'ㄿ', 'ㅎ': 'ㅀ'}, 'ㅂ': {'ㅅ': 'ㅄ'} };
        const JONG_SPLIT = {'ㄳ':'ㄱㅅ', 'ㄵ':'ㄴㅈ', 'ㄶ':'ㄴㅎ', 'ㄺ':'ㄹㄱ', 'ㄻ':'ㄹㅁ', 'ㄼ':'ㄹㅂ', 'ㄽ':'ㄹㅅ', 'ㄾ':'ㄹㅌ', 'ㄿ':'ㄹㅍ', 'ㅀ':'ㄹㅎ', 'ㅄ':'ㅂㅅ'};

        class HangeulAssembler {
            constructor() { this.cho = -1; this.jung = -1; this.jong = -1; this.state = 'start'; }
            getSyllable() {
                if (this.state === 'start') return '';
                if (this.cho === -1 && this.jung !== -1) return JUNG[this.jung];
                if (this.cho !== -1 && this.jung === -1) return CHO[this.cho];
                const charCode = HANGEUL_OFFSET + (this.cho * 21 * 28) + (this.jung * 28) + (this.jong !== -1 ? this.jong : 0);
                return String.fromCharCode(charCode);
            }
            add(char) {
                if (this.state === 'start') {
                    if (isConsonant(char)) { this.cho = CHO.indexOf(char); this.state = 'cho_typed'; } 
                    else if (isVowel(char)) { this.jung = JUNG.indexOf(char); this.state = 'jung_typed'; }
                } else if (this.state === 'cho_typed') {
                    if (isVowel(char)) { this.jung = JUNG.indexOf(char); this.state = 'jung_typed'; }
                } else if (this.state === 'jung_typed') {
                    if (isVowel(char)) {
                        const prevVowel = JUNG[this.jung];
                        if (VOWEL_PAIRS[prevVowel] && VOWEL_PAIRS[prevVowel][char]) { this.jung = JUNG.indexOf(VOWEL_PAIRS[prevVowel][char]); }
                    } else if (isConsonant(char)) {
                        const jongIndex = JONG.indexOf(char);
                        if (jongIndex > 0) { this.jong = jongIndex; this.state = 'jong_typed'; }
                    }
                } else if (this.state === 'jong_typed') {
                    if (isConsonant(char)) {
                        const prevJong = JONG[this.jong];
                        if (CONSONANT_PAIRS[prevJong] && CONSONANT_PAIRS[prevJong][char]) { this.jong = JONG.indexOf(CONSONANT_PAIRS[prevJong][char]); }
                    }
                }
            }
            remove() {
                if (this.state === 'jong_typed') {
                    const jongChar = JONG[this.jong];
                    if (JONG_SPLIT[jongChar]) { this.jong = JONG.indexOf(JONG_SPLIT[jongChar][0]); } 
                    else { this.jong = -1; this.state = 'jung_typed'; }
                } else if (this.state === 'jung_typed') {
                    const jungChar = JUNG[this.jung];
                    let found = false;
                    for (const base in VOWEL_PAIRS) { for(const pair in VOWEL_PAIRS[base]) { if (VOWEL_PAIRS[base][pair] === jungChar) { this.jung = JUNG.indexOf(base); found = true; break; } } if(found) break; }
                    if (!found) { this.jung = -1; this.state = this.cho !== -1 ? 'cho_typed' : 'start'; }
                } else if (this.state === 'cho_typed') { this.cho = -1; this.state = 'start'; }
            }
        }

        function playSound(soundKey) {
            if (!sounds[soundKey]) return;
            Tone.start().then(() => {
                const player = new Tone.Player(sounds[soundKey].file).toDestination();
                player.autostart = true;
                player.onstop = () => player.dispose();
            }).catch(e => console.error("Audio could not start:", e));
        }

        // [MODIFIED] Added postMessage and resetPage logic
        function showPage(pageId) {
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) currentPage.classList.remove('active');
            
            const nextPage = document.getElementById(pageId);
            if (nextPage) {
                nextPage.classList.add('active');
                currentPageId = pageId;

                // [ADDED] postMessage logic
                if (pageId === 'completion-page') {
                    if (window.parent) {
                        window.parent.postMessage({ type: 'lesson_complete' }, '*');
                    }
                }

                if (pageId.startsWith('page-')) { 
                    const quizNumMatch = pageId.match(/page-(\d+)/);
                    if (quizNumMatch && quizData.some(q => q.page == quizNumMatch[1])) {
                        resetPageState(pageId);
                    }
                }
            }
        }
        
        // [MODIFIED] Renamed and adapted from previous file
        function resetPageState(pageId) {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) return;
            const quizDataEntry = quizData.find(q => `page-${q.page}` === pageId);
            if(!quizDataEntry) return;

            const quizNum = quizDataEntry.id;
            const quizNav = pageElement.querySelector(`#quiz-${quizNum}-nav`);
            
            // Restore nav from stored HTML
             if (quizNav && initialNavStates[quizNav.id]) {
                quizNav.innerHTML = initialNavStates[quizNav.id];
                // Re-bind buttons
                const newCheckButton = quizNav.querySelector('button[onclick^="validate"]');
                if (newCheckButton) {
                    newCheckButton.onclick = () => validateDictation(quizNum);
                }
            }

            isShiftActive = false;
            // Re-setup the dictation quiz (clears inputs and redraws keyboard)
            setupDictationQuiz(quizNum, true); 
        }

        function setupDictationQuiz(quizNum, isInitialSetup = false) {
            const data = quizData.find(q => q.id === quizNum);
            if (!data) return;

            if (isInitialSetup) {
                 dictationAssemblers[quizNum] = Array(data.syllables).fill(0).map(() => new HangeulAssembler());
            }
            
            const jamoBank = document.getElementById(`jamo-keyboard-${quizNum}`);
            if (!jamoBank) return;
            jamoBank.innerHTML = ''; 

            // Clear visual inputs
            for(let i=0; i < data.syllables; i++) {
                const inputEl = document.getElementById(`input-${quizNum}-${i}`);
                if (inputEl) inputEl.textContent = '';
            }

            const keyboardLayout = [
                ['ㅂ','ㅈ','ㄷ','ㄱ','ㅅ','ㅛ','ㅕ','ㅑ','ㅐ','ㅔ'],
                ['ㅁ','ㄴ','ㅇ','ㄹ','ㅎ','ㅗ','ㅓ','ㅏ','ㅣ'],
                ['Shift', 'ㅋ','ㅌ','ㅊ','ㅍ','ㅠ','ㅜ','ㅡ', 'Backspace']
            ];
            const shiftedLayout = [
                ['ㅃ','ㅉ','ㄸ','ㄲ','ㅆ','ㅛ','ㅕ','ㅑ','ㅒ','ㅖ'],
                ['ㅁ','ㄴ','ㅇ','ㄹ','ㅎ','ㅗ','ㅓ','ㅏ','ㅣ'],
                ['Shift', 'ㅋ','ㅌ','ㅊ','ㅍ','ㅠ','ㅜ','ㅡ', 'Backspace']
            ];

            keyboardLayout.forEach((row, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'jamo-row';
                const currentLayout = isShiftActive ? shiftedLayout[rowIndex] : keyboardLayout[rowIndex];
                
                currentLayout.forEach((key) => {
                    const keyEl = document.createElement('button');
                    keyEl.className = 'jamo-key';
                    keyEl.textContent = key;
                    if (key === 'Shift') {
                        keyEl.classList.add('shift-key');
                        if(isShiftActive) keyEl.classList.add('active');
                        keyEl.onclick = () => { isShiftActive = !isShiftActive; setupDictationQuiz(quizNum); };
                    } else if (key === 'Backspace') {
                        keyEl.classList.add('backspace-key');
                        keyEl.textContent = '←';
                        keyEl.onclick = () => processJamoInput('Backspace');
                    } else {
                        keyEl.onclick = () => processJamoInput(key);
                    }
                    rowDiv.appendChild(keyEl);
                });
                jamoBank.appendChild(rowDiv);
            });
            updateAllDictationDisplays(quizNum);
            if (isInitialSetup || (activeDictationBox.quizNum !== quizNum)) {
                setActiveDictationBox(quizNum, 0);
            }
        }

        function setActiveDictationBox(quizNum, boxIndex) {
            activeDictationBox = { quizNum, boxIndex };
            document.querySelectorAll(`.syllable-input`).forEach(el => el.classList.remove('active'));
            const currentBox = document.getElementById(`input-${quizNum}-${boxIndex}`);
            if (currentBox) {
                currentBox.classList.add('active');
            }
        }

        function processJamoInput(jamo) {
            const { quizNum, boxIndex } = activeDictationBox;
            if (quizNum === -1 || !dictationAssemblers[quizNum] || !dictationAssemblers[quizNum][boxIndex]) return;

            let assembler = dictationAssemblers[quizNum][boxIndex];

            if (jamo === 'Backspace') {
                if (assembler.state === 'start' && boxIndex > 0) {
                    setActiveDictationBox(quizNum, boxIndex - 1);
                    dictationAssemblers[quizNum][boxIndex - 1].remove();
                } else {
                    assembler.remove();
                }
            } else if (isVowel(jamo)) {
                if (assembler.state === 'jong_typed') {
                    const jongChar = JONG[assembler.jong];
                    let lastConsOfPrevSyllable;
                    let firstConsOfNextSyllable;

                    if (JONG_SPLIT[jongChar]) {
                        const parts = JONG_SPLIT[jongChar];
                        lastConsOfPrevSyllable = parts[0];
                        firstConsOfNextSyllable = parts[1];
                    } else { 
                        lastConsOfPrevSyllable = '';
                        firstConsOfNextSyllable = jongChar;
                    }

                    assembler.jong = JONG.indexOf(lastConsOfPrevSyllable);
                    assembler.state = (assembler.jong > 0) ? 'jong_typed' : 'jung_typed';

                    if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                        setActiveDictationBox(quizNum, boxIndex + 1);
                        const nextAssembler = dictationAssemblers[quizNum][boxIndex + 1];
                        nextAssembler.add(firstConsOfNextSyllable);
                        nextAssembler.add(jamo);
                    }
                } else {
                    assembler.add(jamo);
                }
            } else if (isConsonant(jamo)) {
                if (assembler.state === 'jung_typed') {
                    if (JONG.indexOf(jamo) > 0) { 
                        assembler.add(jamo);
                    } else {
                        if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                            setActiveDictationBox(quizNum, boxIndex + 1);
                            dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                        }
                    }
                } else if (assembler.state === 'jong_typed') {
                    const prevJong = JONG[assembler.jong];
                    if (CONSONANT_PAIRS[prevJong] && CONSONANT_PAIRS[prevJong][jamo]) {
                        assembler.add(jamo);
                    } else {
                        if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                            setActiveDictationBox(quizNum, boxIndex + 1);
                            dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                        }
                    }
                } else { // state is 'start' or 'cho_typed'
                    if (assembler.state === 'start') {
                        assembler.add(jamo);
                    } else { // 'cho_typed' - C + new C -> move to next box
                        if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                            setActiveDictationBox(quizNum, boxIndex + 1);
                            dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                        }
                    }
                }
            }

            updateAllDictationDisplays(quizNum);
            
            if (jamo !== 'Backspace' && isShiftActive) {
                isShiftActive = false;
                setupDictationQuiz(quizNum);
            }
        }
        
        function updateAllDictationDisplays(quizNum) {
            const assemblers = dictationAssemblers[quizNum];
            if (!assemblers) return;
            assemblers.forEach((assembler, index) => {
                const box = document.getElementById(`input-${quizNum}-${index}`);
                if (box) box.textContent = assembler.getSyllable();
            });
        }
        
        function validateDictation(quizNum) {
            const data = quizData.find(q => q.id === quizNum);
            let userAnswer = '';
            const assemblers = dictationAssemblers[quizNum];
            for (let i = 0; i < assemblers.length; i++) {
                userAnswer += assemblers[i].getSyllable();
            }

            const navEl = document.getElementById(`quiz-${quizNum}-nav`);
            const feedbackContainer = navEl.querySelector(`#quiz-${quizNum}-feedback`);
            navEl.querySelector('button[onclick^="validate"]').style.display = 'none';

            const isCorrect = userAnswer === data.answer;
            
            // [MODIFIED] Corrected next page logic
            const nextPageId = (quizNum === quizData[quizData.length - 1].id) ? 'completion-page' : `page-${data.page + 1}`;
            const buttonText = (quizNum === quizData[quizData.length - 1].id) ? 'Terminer' : 'Suivant &rarr;';
            
            if (isCorrect) {
                feedbackContainer.innerHTML = `<button onclick="showPage('${nextPageId}')" class="nav-button bg-green-600 text-white hover:bg-green-700">${buttonText}</button>`;
            } else {
                // [MODIFIED] Added font-size to feedback
                feedbackContainer.innerHTML = `<p class="text-red-600 font-bold mr-2" style="font-size: var(--font-base);">Incorrect.</p><button onclick="resetQuiz(${quizNum})" class="nav-button bg-red-600 text-white hover:bg-red-700">Réessayer</button>`;
            }
        }
        
        function resetQuiz(quizNum) {
            const pageId = `page-${quizData.find(q => q.id === quizNum).page}`;
            resetPageState(pageId);
        }

        function createPages() {
            const container = document.querySelector('.course-container');
            let pagesHtml = `
                <div id="page-0" class="page active"> <div class="page-content text-center"> 
                    <!-- [MODIFIED] Removed leading-tight -->
                    <h1 class="title-text font-bold text-gray-800">Chapitre 8<br>Les consonnes finales - comment-elles fonctionnent?</h1> 
                    <button onclick="showPage('page-1')" class="nav-button bg-blue-600 text-white hover:bg-blue-700 mt-8">Commencer</button> 
                </div> <div></div> </div>
                <div id="page-1" class="page"> <div class="page-content items-center"> <p class="lesson-text text-center leading-relaxed"><strong class="font-semibold text-blue-600">받침</strong> (batchim / consonne finale) est une consonne supplémentaire qui se met <strong class="font-semibold text-blue-600">au-dessous</strong> d’une syllabe. Toutes les consonnes sauf &lt;ㄸ,ㅃ,ㅉ&gt; peuvent se trouver en position finale.</p> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-0')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Titre</button> <button onclick="showPage('page-2')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> </div>
                <div id="page-2" class="page"> <div class="page-content items-center"> <p class="lesson-text text-center leading-relaxed">Les consonnes, quand elles se prononcent en position finale, ne se prononcent pas entièrement comme elles ne sont pas suivies d’une voyelle et il n’est alors plus nécessaire d’expirer l’air ou de rouvrir la bouche.</p> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-1')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-3')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> </div>
                <div id="page-3" class="page"> <div class="page-content items-center"> <p class="lesson-text text-center leading-relaxed">Par conséquent, les sons aspirés et tendus sont tous les deux représentés par les sons basiques en position finale et <strong class="font-semibold text-blue-600">il n’existe que 7 manières &lt;ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅇ&gt; de prononcer les consonnes finales.</strong></p> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-2')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-4')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> </div>
                <div id="page-4" class="page"> <div class="page-content items-center"> <p class="lesson-text text-center leading-relaxed">Il faut bien distinguer les sons selon leurs positions et ne pas les confondre aux sons finals du français.</p> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-3')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-5')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> </div>
                <div id="page-5" class="page"> <div class="page-content items-center"> <p class="lesson-text text-center leading-relaxed">La liaison d’une consonne finale est obligatoire quand elle est suivie par une voyelle (quand le caractère suivant n’as pas de consonne prononcée et il est rempli par &lt;ᄋ&gt; muet).</p> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-4')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-6')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> </div>
                <div id="page-6" class="page"> <div class="page-content"> <p class="lesson-text mb-6">Pratiquons avec &lt;ㅇ&gt; que nous avons appris au chapitre 6. Les consonnes finales se placent en bas d'une syllabe, au milieu.</p> <div class="flex justify-center gap-2 sm:gap-4"> <button class="char-button" style="font-size: clamp(2.5rem, 10vw, 4rem);" onclick="playSound('gang')">강</button> <button class="char-button" style="font-size: clamp(2.5rem, 10vw, 4rem);" onclick="playSound('bang')">방</button> <button class="char-button" style="font-size: clamp(2.5rem, 10vw, 4rem);" onclick="playSound('jong')">종</button> </div> </div> <div class="flex justify-between items-center"> <button onclick="showPage('page-5')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-7')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Faire le quiz &rarr;</button> </div> </div>
            `;
            
            quizData.forEach((data) => {
                const { id: quizNum, page, sound, syllables } = data;
                let syllableInputs = '';
                for(let i=0; i < syllables; i++) {
                    syllableInputs += `<div id="input-${quizNum}-${i}" class="syllable-input" onclick="setActiveDictationBox(${quizNum}, ${i})"></div>`;
                }

                let contentHtml = `
                    <p class="quiz-question">Écrivez en coréen.</p>
                    <button class="audio-button" onclick="playSound('${sound}')"><svg class="audio-icon mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg></button>
                    <div class="syllable-container">${syllableInputs}</div>
                    <div id="jamo-keyboard-${quizNum}" class="jamo-bank"></div>
                `;

                const prevButtonHtml = page === 7 ? `<button onclick="showPage('page-6')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Leçon</button>` : `<button onclick="showPage('page-${page - 1}')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button>`;
                const navButtonHtml = `
                    <div id="quiz-${quizNum}-nav" class="flex justify-between items-center w-full">
                        ${prevButtonHtml}
                        <div class="flex items-center gap-4">
                           <div id="quiz-${quizNum}-feedback" class="feedback-area"></div>
                           <button onclick="validateDictation(${quizNum})" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Valider</button>
                        </div>
                    </div>`;

                pagesHtml += `
                    <div id="page-${page}" class="page">
                        <div class="page-content writing-quiz-content">${contentHtml}</div>
                        ${navButtonHtml}
                    </div>
                `;
            });

            const completionPageHtml = `<div id="completion-page" class="page"> <div class="page-content"> <svg class="w-20 h-20 mx-auto mb-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <h2 class="title-text font-bold text-gray-800 mb-3">Chapitre terminé !</h2> <p class="lesson-text text-gray-600">Félicitations, vous avez terminé le chapitre.</p> </div> <div class="w-full text-center pb-4"> <button onclick="showPage('page-0')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Recommencer</button> </div> </div>`;
            container.innerHTML = pagesHtml + completionPageHtml;
        }

        function initializeApp() {
            createPages();
            
            quizData.forEach(q => {
                if (q.type === 'writing') setupDictationQuiz(q.id, true);
            });
            
            // [ADDED] Store initial nav states
            document.querySelectorAll('[id$="-nav"]').forEach(nav => {
                initialNavStates[nav.id] = nav.innerHTML;
            });
            
            showPage('page-0');
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
