<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Chapitre 8 - Les consonnes finales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --font-sm: clamp(0.75rem, 1.5vh, 0.875rem);
            --font-base: clamp(0.875rem, 2vh, 1rem);
            --font-lg: clamp(1rem, 2.5vh, 1.25rem);
            --font-xl: clamp(1.125rem, 3vh, 1.5rem);
            --font-title: clamp(1.5rem, 4vh, 2rem);
            --font-char-btn: clamp(2rem, 10vw, 3rem);
            --font-jamo-key: clamp(0.9rem, 2.2vh, 1.1rem);
            --padding-lg: clamp(1rem, 3vh, 2rem);
        }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            display: flex; align-items: center; justify-content: center;
            background-color: #f3f4f6;
        }

        .course-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .course-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            /* 데스크탑 기본: 정사각형 비율 */
            aspect-ratio: 1 / 1; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: white;
            display: flex;
            flex-direction: column;
        }

        /* [모바일 화면 대응] 비율 해제 및 전체 화면 채움 */
        @media (max-width: 600px) {
            body { padding: 0; background-color: white; }
            .course-wrapper { padding: 0; height: 100vh; width: 100vw; }
            .course-container {
                max-width: none;
                width: 100%;
                height: 100%;
                aspect-ratio: auto; /* 비율 강제 해제 */
                border-radius: 0;
                box-shadow: none;
            }
            .page { border-radius: 0; padding: 1rem; }
        }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;
            padding: var(--padding-lg);
            box-sizing: border-box;
        }
        .page.active { opacity: 1; visibility: visible; }
        
        .page-content {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            text-align: center;
            width: 100%;
        }

        /* 텍스트 스타일 */
        .title-text { font-size: var(--font-title); font-weight: 700; text-align: center; margin-bottom: 2vh; color: #1f2937; }
        .lesson-text { font-size: var(--font-lg); color: #4b5563; line-height: 1.6; max-width: 90%; margin: 0 auto; }
        
        /* 버튼 스타일 */
        .nav-button { 
            padding: clamp(0.6rem, 2vh, 0.8rem) clamp(1.2rem, 4vh, 1.6rem);
            border-radius: 0.5rem; 
            font-weight: 600; 
            font-size: clamp(1rem, 2.5vh, 1.1rem);
            transition: background-color 0.2s; 
        }
        
        .char-button {
            font-size: var(--font-char-btn); font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
            background-color: #eff6ff; border: 2px solid #93c5fd;
            border-radius: 1rem; padding: 1rem 1.5rem;
            cursor: pointer; transition: background-color 0.2s, transform 0.1s;
            line-height: 1.1;
        }
        .char-button:hover { background-color: #dbeafe; }
        .char-button:active { transform: scale(0.95); }

        /* 퀴즈 스타일 */
        .quiz-question { font-weight: 600; font-size: var(--font-lg); color: #1f2937; margin-bottom: 2vh; }
        .audio-button { background: none; border: none; cursor: pointer; margin-bottom: 2vh; }
        .audio-icon { width: clamp(3rem, 8vh, 4rem); height: clamp(3rem, 8vh, 4rem); color: #6b7280; transition: color 0.2s; }
        .audio-button:hover .audio-icon { color: #1d4ed8; }
        
        .feedback-area { 
            text-align: right; min-height: 40px; 
            display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center; 
            font-size: var(--font-base);
        }
        
        /* 쓰기 퀴즈 스타일 */
        .syllable-container { 
            display: flex; flex-wrap: wrap; gap: 0.5rem; 
            justify-content: center; align-items: center; 
            min-height: clamp(80px, 15vh, 100px); 
            margin-bottom: 2vh;
        }
        .syllable-input { 
            border: 2px solid #cbd5e1; background-color: #f9fafb; 
            width: clamp(70px, 18vw, 100px); height: clamp(70px, 18vw, 100px); 
            font-size: var(--font-char-btn); font-family: 'Noto Sans KR', sans-serif; 
            font-weight: 700; display: flex; justify-content: center; align-items: center; 
            cursor: pointer; transition: border-color 0.2s; border-radius: 0.5rem;
        }
        .syllable-input.active { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* 자모 키보드 */
        .jamo-bank { 
            display: flex; flex-direction: column; gap: 0.3rem; 
            justify-content: center; padding: 0.5rem; 
            border-top: 1px solid #e5e7eb; 
            width: 100%; max-width: 500px;
        }
        .jamo-row { display: flex; flex-wrap: nowrap; gap: 0.3rem; justify-content: center; width: 100%; }
        .jamo-key {
            flex: 1; height: clamp(36px, 6vh, 48px);
            font-size: var(--font-jamo-key);
            font-family: 'Noto Sans KR', sans-serif; font-weight: 600;
            border: 1px solid #d1d5db; border-bottom-width: 3px;
            border-radius: 0.375rem; background-color: #ffffff;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .jamo-key:active { background-color: #e5e7eb; border-bottom-width: 1px; transform: translateY(2px); }
        .shift-key { flex-grow: 1.5; }
        .shift-key.active { background-color: #a5b4fc; color: white; border-color: #6366f1; }
        .backspace-key { flex-grow: 1.5; }
    </style>
</head>
<body>

    <div class="course-wrapper">
        <div class="course-container">
            <!-- Content generated by JS -->
        </div>
    </div>

    <script>
        let currentPageId = 'page-0';
        let dictationAssemblers = {};
        let activeDictationBox = { quizNum: -1, boxIndex: -1 };
        let isShiftActive = false;
        let initialNavStates = {};
        let attemptCounts = {}; // Track incorrect attempts

        const sounds = {
            'gang': { file: 'https://static.wixstatic.com/mp3/699687_44c30ee2cd9e42ff8eb001f66a0b44f3.mp3' },
            'bang': { file: 'https://static.wixstatic.com/mp3/699687_c065955a571544588c47617c39f40b55.mp3' },
            'jong': { file: 'https://static.wixstatic.com/mp3/699687_1f37c39b0a0d4dffb18877e5a34f65c4.mp3' },
            'yeonghwa': { file: 'https://static.wixstatic.com/mp3/699687_690073b12fce4ec69779a69eb4543160.mp3' },
        };
        
        const quizData = [
            { id: 1, page: 7, type: 'writing', sound: 'bang', answer: '방', syllables: 1 },
            { id: 2, page: 8, type: 'writing', sound: 'yeonghwa', answer: '영화', syllables: 2 },
        ];
        
        const HANGEUL_OFFSET = 0xAC00;
        const CHO = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const JUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
        const JONG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        
        const isVowel = (c) => JUNG.includes(c);
        const isConsonant = (c) => CHO.includes(c);
        
        const VOWEL_PAIRS = { 'ㅗ': {'ㅏ': 'ㅘ', 'ㅐ': 'ㅙ', 'ㅣ': 'ㅚ'}, 'ㅜ': {'ㅓ': 'ㅝ', 'ㅔ': 'ㅞ', 'ㅣ': 'ㅟ'}, 'ㅡ': {'ㅣ': 'ㅢ'} };
        const CONSONANT_PAIRS = { 'ㄱ': {'ㅅ': 'ㄳ'}, 'ㄴ': {'ㅈ': 'ㄵ', 'ㅎ': 'ㄶ'}, 'ㄹ': {'ㄱ': 'ㄺ', 'ㅁ': 'ㄻ', 'ㅂ': 'ㄼ', 'ㅅ': 'ㄽ', 'ㅌ': 'ㄾ', 'ㅍ': 'ㄿ', 'ㅎ': 'ㅀ'}, 'ㅂ': {'ㅅ': 'ㅄ'} };
        const JONG_SPLIT = {'ㄳ':'ㄱㅅ', 'ㄵ':'ㄴㅈ', 'ㄶ':'ㄴㅎ', 'ㄺ':'ㄹㄱ', 'ㄻ':'ㄹㅁ', 'ㄼ':'ㄹㅂ', 'ㄽ':'ㄹㅅ', 'ㄾ':'ㄹㅌ', 'ㄿ':'ㄹㅍ', 'ㅀ':'ㄹㅎ', 'ㅄ':'ㅂㅅ'};

        class HangeulAssembler {
            constructor() { this.cho = -1; this.jung = -1; this.jong = -1; this.state = 'start'; }
            getSyllable() {
                if (this.state === 'start') return '';
                if (this.cho === -1 && this.jung !== -1) return JUNG[this.jung];
                if (this.cho !== -1 && this.jung === -1) return CHO[this.cho];
                const charCode = HANGEUL_OFFSET + (this.cho * 21 * 28) + (this.jung * 28) + (this.jong !== -1 ? this.jong : 0);
                return String.fromCharCode(charCode);
            }
            add(char) {
                if (this.state === 'start') {
                    if (isConsonant(char)) { this.cho = CHO.indexOf(char); this.state = 'cho_typed'; } 
                    else if (isVowel(char)) { this.jung = JUNG.indexOf(char); this.state = 'jung_typed'; }
                } else if (this.state === 'cho_typed') {
                    if (isVowel(char)) { this.jung = JUNG.indexOf(char); this.state = 'jung_typed'; }
                } else if (this.state === 'jung_typed') {
                    if (isVowel(char)) {
                        const prevVowel = JUNG[this.jung];
                        if (VOWEL_PAIRS[prevVowel] && VOWEL_PAIRS[prevVowel][char]) { this.jung = JUNG.indexOf(VOWEL_PAIRS[prevVowel][char]); }
                    } else if (isConsonant(char)) {
                        const jongIndex = JONG.indexOf(char);
                        if (jongIndex > 0) { this.jong = jongIndex; this.state = 'jong_typed'; }
                    }
                } else if (this.state === 'jong_typed') {
                    if (isConsonant(char)) {
                        const prevJong = JONG[this.jong];
                        if (CONSONANT_PAIRS[prevJong] && CONSONANT_PAIRS[prevJong][char]) { this.jong = JONG.indexOf(CONSONANT_PAIRS[prevJong][char]); }
                    }
                }
            }
            remove() {
                if (this.state === 'jong_typed') {
                    const jongChar = JONG[this.jong];
                    if (JONG_SPLIT[jongChar]) { this.jong = JONG.indexOf(JONG_SPLIT[jongChar][0]); } 
                    else { this.jong = -1; this.state = 'jung_typed'; }
                } else if (this.state === 'jung_typed') {
                    const jungChar = JUNG[this.jung];
                    let found = false;
                    for (const base in VOWEL_PAIRS) { for(const pair in VOWEL_PAIRS[base]) { if (VOWEL_PAIRS[base][pair] === jungChar) { this.jung = JUNG.indexOf(base); found = true; break; } } if(found) break; }
                    if (!found) { this.jung = -1; this.state = this.cho !== -1 ? 'cho_typed' : 'start'; }
                } else if (this.state === 'cho_typed') { this.cho = -1; this.state = 'start'; }
            }
        }

        function playSound(soundKey) {
            if (!sounds[soundKey]) return;
            Tone.start().then(() => {
                const player = new Tone.Player(sounds[soundKey].file).toDestination();
                player.autostart = true;
            }).catch(e => console.error(e));
        }

        function showPage(pageId) {
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) currentPage.classList.remove('active');
            
            const nextPage = document.getElementById(pageId);
            if (nextPage) {
                nextPage.classList.add('active');
                currentPageId = pageId;

                if (pageId === 'completion-page') {
                    if (window.parent) {
                        window.parent.postMessage({ type: 'lesson_complete' }, '*');
                    }
                }

                if (pageId.startsWith('page-')) { 
                    const quizNumMatch = pageId.match(/page-(\d+)/);
                    if (quizNumMatch && quizData.some(q => q.page == quizNumMatch[1])) {
                        resetPageState(pageId);
                    }
                }
            }
        }
        
        function resetPageState(pageId) {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) return;
            const quizDataEntry = quizData.find(q => `page-${q.page}` === pageId);
            if(!quizDataEntry) return;

            const quizNum = quizDataEntry.id;
            const quizNav = pageElement.querySelector(`#quiz-${quizNum}-nav`);
            
            if (quizNav && initialNavStates[quizNav.id]) {
                quizNav.innerHTML = initialNavStates[quizNav.id];
                const newCheckButton = quizNav.querySelector('button[onclick^="validate"]');
                if (newCheckButton) {
                    newCheckButton.onclick = () => validateDictation(quizNum);
                }
            }

            isShiftActive = false;
            // Clear attempts when fully resetting page entrance (optional, usually kept if retrying same session)
            // But here "resetPageState" is called on navigation.
            // If we want to persist "3 strikes" logic, we shouldn't clear it here unless it's a full restart.
            // For now, let's keep it persistent per session.
            
            setupDictationQuiz(quizNum, true); 
        }

        function setupDictationQuiz(quizNum, isInitialSetup = false) {
            const data = quizData.find(q => q.id === quizNum);
            if (!data) return;

            if (isInitialSetup) {
                 dictationAssemblers[quizNum] = Array(data.syllables).fill(0).map(() => new HangeulAssembler());
                 // Reset attempt count for this quiz? 
                 // If we re-enter the page, we might want to reset.
                 attemptCounts[quizNum] = 0;
            }
            
            const jamoBank = document.getElementById(`jamo-keyboard-${quizNum}`);
            if (!jamoBank) return;
            jamoBank.innerHTML = ''; 

            for(let i=0; i < data.syllables; i++) {
                const inputEl = document.getElementById(`input-${quizNum}-${i}`);
                if (inputEl) inputEl.textContent = '';
            }

            const keyboardLayout = [
                ['ㅂ','ㅈ','ㄷ','ㄱ','ㅅ','ㅛ','ㅕ','ㅑ','ㅐ','ㅔ'],
                ['ㅁ','ㄴ','ㅇ','ㄹ','ㅎ','ㅗ','ㅓ','ㅏ','ㅣ'],
                ['Shift', 'ㅋ','ㅌ','ㅊ','ㅍ','ㅠ','ㅜ','ㅡ', 'Del']
            ];
            const shiftedLayout = [
                ['ㅃ','ㅉ','ㄸ','ㄲ','ㅆ','ㅛ','ㅕ','ㅑ','ㅒ','ㅖ'],
                ['ㅁ','ㄴ','ㅇ','ㄹ','ㅎ','ㅗ','ㅓ','ㅏ','ㅣ'],
                ['Shift', 'ㅋ','ㅌ','ㅊ','ㅍ','ㅠ','ㅜ','ㅡ', 'Del']
            ];

            keyboardLayout.forEach((row, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'jamo-row';
                const currentLayout = isShiftActive ? shiftedLayout[rowIndex] : keyboardLayout[rowIndex];
                
                currentLayout.forEach((key) => {
                    const keyEl = document.createElement('button');
                    keyEl.className = 'jamo-key';
                    keyEl.textContent = key === 'Del' ? '←' : key;
                    if (key === 'Shift') {
                        keyEl.classList.add('shift-key');
                        if(isShiftActive) keyEl.classList.add('active');
                        keyEl.onclick = () => { isShiftActive = !isShiftActive; setupDictationQuiz(quizNum); };
                    } else if (key === 'Del') {
                        keyEl.classList.add('backspace-key');
                        keyEl.onclick = () => processJamoInput('Backspace');
                    } else {
                        keyEl.onclick = () => processJamoInput(key);
                    }
                    rowDiv.appendChild(keyEl);
                });
                jamoBank.appendChild(rowDiv);
            });
            updateAllDictationDisplays(quizNum);
            if (isInitialSetup || (activeDictationBox.quizNum !== quizNum)) {
                setActiveDictationBox(quizNum, 0);
            }
        }

        function setActiveDictationBox(quizNum, boxIndex) {
            activeDictationBox = { quizNum, boxIndex };
            document.querySelectorAll(`.syllable-input`).forEach(el => el.classList.remove('active'));
            const currentBox = document.getElementById(`input-${quizNum}-${boxIndex}`);
            if (currentBox) {
                currentBox.classList.add('active');
            }
        }

        function processJamoInput(jamo) {
            const { quizNum, boxIndex } = activeDictationBox;
            if (quizNum === -1 || !dictationAssemblers[quizNum] || !dictationAssemblers[quizNum][boxIndex]) return;

            let assembler = dictationAssemblers[quizNum][boxIndex];

            if (jamo === 'Backspace') {
                if (assembler.state === 'start' && boxIndex > 0) {
                    setActiveDictationBox(quizNum, boxIndex - 1);
                    dictationAssemblers[quizNum][boxIndex - 1].remove();
                } else {
                    assembler.remove();
                }
            } else if (isVowel(jamo)) {
                // ... (Logic shortened for brevity, assumes standard Hangul assembly) ...
                if (assembler.state === 'jong_typed') {
                    const jongChar = JONG[assembler.jong];
                    let lastCons, firstCons;
                    if (JONG_SPLIT[jongChar]) { lastCons = JONG_SPLIT[jongChar][0]; firstCons = JONG_SPLIT[jongChar][1]; } 
                    else { lastCons = ''; firstCons = jongChar; }
                    assembler.jong = JONG.indexOf(lastCons);
                    assembler.state = (assembler.jong > 0) ? 'jong_typed' : 'jung_typed';
                    if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                        setActiveDictationBox(quizNum, boxIndex + 1);
                        const nextAss = dictationAssemblers[quizNum][boxIndex + 1];
                        nextAss.add(firstCons); nextAss.add(jamo);
                    }
                } else { assembler.add(jamo); }
            } else if (isConsonant(jamo)) {
                if (assembler.state === 'jung_typed') {
                    if (JONG.indexOf(jamo) > 0) assembler.add(jamo);
                    else if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                        setActiveDictationBox(quizNum, boxIndex + 1);
                        dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                    }
                } else if (assembler.state === 'jong_typed') {
                    const prevJong = JONG[assembler.jong];
                    if (CONSONANT_PAIRS[prevJong] && CONSONANT_PAIRS[prevJong][jamo]) assembler.add(jamo);
                    else if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                        setActiveDictationBox(quizNum, boxIndex + 1);
                        dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                    }
                } else {
                    if (assembler.state === 'start') assembler.add(jamo);
                    else if (boxIndex + 1 < dictationAssemblers[quizNum].length) {
                        setActiveDictationBox(quizNum, boxIndex + 1);
                        dictationAssemblers[quizNum][boxIndex + 1].add(jamo);
                    }
                }
            }

            updateAllDictationDisplays(quizNum);
            
            if (jamo !== 'Backspace' && isShiftActive) {
                isShiftActive = false;
                setupDictationQuiz(quizNum);
            }
        }
        
        function updateAllDictationDisplays(quizNum) {
            const assemblers = dictationAssemblers[quizNum];
            if (!assemblers) return;
            assemblers.forEach((assembler, index) => {
                const box = document.getElementById(`input-${quizNum}-${index}`);
                if (box) box.textContent = assembler.getSyllable();
            });
        }
        
        function validateDictation(quizNum) {
            const data = quizData.find(q => q.id === quizNum);
            let userAnswer = '';
            const assemblers = dictationAssemblers[quizNum];
            for (let i = 0; i < assemblers.length; i++) {
                userAnswer += assemblers[i].getSyllable();
            }

            const navEl = document.getElementById(`quiz-${quizNum}-nav`);
            const feedbackContainer = navEl.querySelector(`#quiz-${quizNum}-feedback`);
            const validateBtn = navEl.querySelector('button[onclick^="validate"]');

            const isCorrect = userAnswer === data.answer;
            
            // [MODIFIED] Logic for next page button
            const isLast = (quizNum === quizData[quizData.length - 1].id);
            const nextPageId = isLast ? 'completion-page' : `page-${data.page + 1}`;
            const buttonText = isLast ? 'Terminer' : 'Suivant &rarr;';
            const nextButtonHtml = `<button onclick="showPage('${nextPageId}')" class="nav-button bg-green-600 text-white hover:bg-green-700">${buttonText}</button>`;
            
            if (isCorrect) {
                validateBtn.style.display = 'none';
                feedbackContainer.innerHTML = nextButtonHtml;
            } else {
                // Increment attempts
                if (!attemptCounts[quizNum]) attemptCounts[quizNum] = 0;
                attemptCounts[quizNum]++;

                if (attemptCounts[quizNum] >= 3) {
                    // 3 strikes: Show answer and let proceed
                    validateBtn.style.display = 'none';
                    // Show Correct Answer in inputs visually
                    const correctChars = data.answer.split('');
                    correctChars.forEach((char, idx) => {
                        const box = document.getElementById(`input-${quizNum}-${idx}`);
                        if(box) {
                            box.textContent = char;
                            box.style.color = '#dc2626'; // Mark red to indicate it was wrong
                            box.style.borderColor = '#dc2626';
                        }
                    });
                    
                    feedbackContainer.innerHTML = `<span class="text-red-600 font-bold mr-2 text-sm">3 fautes. Réponse : ${data.answer}</span> ${nextButtonHtml}`;
                } else {
                    // Less than 3 strikes: Retry
                    feedbackContainer.innerHTML = `<span class="text-red-600 font-bold mr-2 text-sm">Incorrect.</span><button onclick="resetQuiz(${quizNum})" class="nav-button bg-red-600 text-white hover:bg-red-700">Réessayer</button>`;
                    validateBtn.style.display = 'none';
                }
            }
        }
        
        function resetQuiz(quizNum) {
            // This is called by "Réessayer" button
            // Just clear feedback and inputs
            const navEl = document.getElementById(`quiz-${quizNum}-nav`);
            const feedbackContainer = navEl.querySelector(`#quiz-${quizNum}-feedback`);
            feedbackContainer.innerHTML = '';
            
            // Restore Validate button
            // We need to re-inject the validate button since it was hidden/removed
            // Simplest way is to reload the nav state or just show the hidden button if we didn't remove it.
            // But we modified innerHTML or display.
            
            // Let's rely on resetPageState logic which redraws keyboard and inputs
            const pageId = `page-${quizData.find(q => q.id === quizNum).page}`;
            
            // Restore nav HTML from initial state to bring back "Valider" button
            const quizNav = document.getElementById(`quiz-${quizNum}-nav`);
            if (quizNav && initialNavStates[quizNav.id]) {
                quizNav.innerHTML = initialNavStates[quizNav.id];
                const newCheckButton = quizNav.querySelector('button[onclick^="validate"]');
                if (newCheckButton) newCheckButton.onclick = () => validateDictation(quizNum);
            }
            
            // Re-setup quiz inputs
            setupDictationQuiz(quizNum, false); 
        }

        function createPages() {
            const container = document.querySelector('.course-container');
            let pagesHtml = `
                <div id="page-0" class="page active"> 
                    <div class="page-content text-center"> 
                        <h1 class="title-text font-bold text-gray-800">Chapitre 8<br>Les consonnes finales</h1> 
                        <button onclick="showPage('page-1')" class="nav-button bg-blue-600 text-white hover:bg-blue-700 mt-8">Commencer</button> 
                    </div> 
                </div>
                <div id="page-1" class="page"> 
                    <div class="page-content items-center"> 
                        <p class="lesson-text text-center"><strong class="font-semibold text-blue-600">받침</strong> (batchim / consonne finale) est une consonne supplémentaire qui se met <strong class="font-semibold text-blue-600">au-dessous</strong> d’une syllabe.</p> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-0')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Titre</button> <button onclick="showPage('page-2')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> 
                </div>
                <div id="page-2" class="page"> 
                    <div class="page-content items-center"> 
                        <p class="lesson-text text-center">Les consonnes finales ne se prononcent pas entièrement.</p> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-1')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-3')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> 
                </div>
                <div id="page-3" class="page"> 
                    <div class="page-content items-center"> 
                        <p class="lesson-text text-center">Il n’existe que 7 manières &lt;ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅇ&gt; de prononcer les consonnes finales.</p> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-2')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-4')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> 
                </div>
                <div id="page-4" class="page"> 
                    <div class="page-content items-center"> 
                        <p class="lesson-text text-center">Il faut bien distinguer les sons selon leurs positions.</p> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-3')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-5')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> 
                </div>
                <div id="page-5" class="page"> 
                    <div class="page-content items-center"> 
                        <p class="lesson-text text-center">La liaison est obligatoire quand elle est suivie par une voyelle.</p> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-4')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-6')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Suivant &rarr;</button> </div> 
                </div>
                <div id="page-6" class="page"> 
                    <div class="page-content"> 
                        <p class="lesson-text mb-6">Pratiquons avec &lt;ㅇ&gt;.</p> 
                        <div class="flex justify-center gap-2"> 
                            <button class="char-button" onclick="playSound('gang')">강</button> 
                            <button class="char-button" onclick="playSound('bang')">방</button> 
                            <button class="char-button" onclick="playSound('jong')">종</button> 
                        </div> 
                    </div> 
                    <div class="flex justify-between items-center w-full"> <button onclick="showPage('page-5')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button> <button onclick="showPage('page-7')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Faire le quiz &rarr;</button> </div> 
                </div>
            `;
            
            quizData.forEach((data) => {
                const { id: quizNum, page, sound, syllables } = data;
                let syllableInputs = '';
                for(let i=0; i < syllables; i++) {
                    syllableInputs += `<div id="input-${quizNum}-${i}" class="syllable-input" onclick="setActiveDictationBox(${quizNum}, ${i})"></div>`;
                }

                let contentHtml = `
                    <p class="quiz-question">Écrivez en coréen.</p>
                    <button class="audio-button" onclick="playSound('${sound}')"><svg class="audio-icon mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg></button>
                    <div class="syllable-container">${syllableInputs}</div>
                    <div id="jamo-keyboard-${quizNum}" class="jamo-bank"></div>
                `;

                const prevButtonHtml = `<button onclick="showPage('page-${page - 1}')" class="nav-button text-gray-600 hover:bg-gray-200">&larr; Précédent</button>`;
                const navButtonHtml = `
                    <div id="quiz-${quizNum}-nav" class="flex justify-between items-center w-full">
                        ${prevButtonHtml}
                        <div class="flex items-center gap-4">
                           <div id="quiz-${quizNum}-feedback" class="feedback-area"></div>
                           <button onclick="validateDictation(${quizNum})" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Valider</button>
                        </div>
                    </div>`;

                pagesHtml += `
                    <div id="page-${page}" class="page">
                        <div class="page-content writing-quiz-content">${contentHtml}</div>
                        ${navButtonHtml}
                    </div>
                `;
            });

            const completionPageHtml = `<div id="completion-page" class="page"> <div class="page-content"> <svg class="w-20 h-20 mx-auto mb-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <h2 class="title-text font-bold text-gray-800 mb-3">Chapitre terminé !</h2> <p class="lesson-text text-gray-600">Félicitations, vous avez terminé le chapitre.</p> </div> <div class="w-full text-center pb-4"> <button onclick="showPage('page-0')" class="nav-button bg-blue-600 text-white hover:bg-blue-700">Recommencer</button> </div> </div>`;
            container.innerHTML = pagesHtml + completionPageHtml;
        }

        function initializeApp() {
            createPages();
            
            quizData.forEach(q => {
                if (q.type === 'writing') setupDictationQuiz(q.id, true);
            });
            
            document.querySelectorAll('[id$="-nav"]').forEach(nav => {
                initialNavStates[nav.id] = nav.innerHTML;
            });
            
            showPage('page-0');
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
